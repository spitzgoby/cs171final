{"version":3,"sources":["main.min.js"],"names":["loadData","error","topo","deaths","income","unemployment","drugUse","console","log","objects","usa","geometries","sort","a","b","id","forEach","state","years","year","death_rate","population","parseYear","median_income","dataLoaded","createVis","choropleth","Choropleth","eventHandler","handler","initVis","scatterplot","Scatterplot","yearSlider","YearSlider","on","this","displaySliderDescription","treemap","Treemap","singleYearSlider","SingleYearSlider","drugTypes","children","map","d","name","reverse","drugTypeLegend","DrugTypeLegend","updateFactor","factor","options","duration","broadcast","$","modal","parentElem","data","displayData","sizeGroup","types","EventHandler","listeners","Regression","xSeries","_xSeries","ySeries","_ySeries","reduceSum","prev","cur","coefficients","self","xBar","reduce","length","yBar","ssXX","Math","pow","ssYY","ssXY","i","slope","intercept","rSquare","format","formatIdentity","domain","d3","min","max","shortName","formatCurrency","formatPercent","factorYear","deathRateYear","regression","loadStackedArea","margin","top","right","bottom","left","width","parseInt","select","style","height","parseDate","time","parse","x","scale","range","y","linear","axisYScale","color","category20","xAxis","svg","axis","orient","yAxis","tickFormat","area","date","y0","y1","stack","layout","values","title","selectAll","remove","append","text","legend","attr","tsv","keys","filter","key","substances","extent","legendElements","enter","substance","tip","show","hide","call","html","makeTable","table","number","getFullYear","replace","changeToOther","change","loadTreemap","treeData","year_index","topYear","bottomYear","colors","markers","hover","normal","formatYear","str","colorbrewer","Purples","unshift","stateColors","quantile","drugColors","dataDir","d3_queue","queue","defer","json","await","window","prototype","_eventHandler","handleUpdate","handleResize","drawHighlight","removeHighlight","vis","keyHeight","keyRectHeight","classed","graph","keyTitle","projection","geo","albersUsa","path","resize","keyWidth","floor","translate","update","keyLabelOffset","fontSize","wrangleData","getTime","keyRects","transition","keyLabels","states","topojson","feature","features","highlightState","unhighlightState","event","elementWidth","elements","elementsEnter","eventName","listener","callback","push","bind","sender","padding","scatter","bfl","xAxisG","yAxisG","ticks","xTitle","yTitle","stateTip","direction","offset","bflTip","correlation","toFixed","labelFontSize","yAxisTicks","current","factorData","deathYearData","factorYearData","dots","coeff","bflData","x1","x2","y2","sqrt","regLine","highlightBFL","unhighlightBFL","stateIndex","clamp","brush","brushed","background","tickSize","tickPadding","parentNode","appendChild","cloneNode","slider","handle","value","round","sourceEvent","invert","switchView","opacity","sticky","size","node","root","nodes","cells","cellsEnter","zoom","parent","dx","dy","w","getComputedTextLength","kx","ky","t","altKey","type","stopPropagation","question","descriptiveText","marker","radius","tick","yearsText","topSlider","bottomSlider","topAxis","bottomAxis","topAxisLine","bottomAxisLine","topText","bottomText","questionButton","questionClicked","dragTopMarker","behavior","drag","topMarkerStartedDragging","markerDragged","markerEndedDragging","dragBottomMarker","bottomMarkerStartedDragging","updateMarkers","updateText","maxYear","minYear","topMarker","changeMarkerColor","bottomMarker","draggingSlider","draggingYear","markerStartedDragging","toString"],"mappings":"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","file":"main.min.js","sourcesContent":["  \n// convert year strings to date objects\nvar formatYear = d3.time.format('%Y');\nvar parseYear = formatYear.parse;\n\nvar formatPercent = d3.format('%');\nvar formatCurrency = d3.format('$');\nvar formatIdentity = function(str) { return str; };\n\n// universal color scale\ncolorbrewer.Purples[6].unshift('#ffffff'); // unshift places white as the first color\nvar stateColors = d3.scale.quantile()\n  .range(colorbrewer.Purples[6]);\nvar drugColors = d3.scale.category20();\n    \n/***---------------------***\n *** LOAD AND PARSE DATA ***\n ***---------------------***/\n  \n// load all data before cleaning\nvar dataLoaded = false;\nvar dataDir = 'data/';\nd3_queue.queue()\n  .defer(d3.json, dataDir+'topo_usa.json')\n  .defer(d3.json, dataDir+'state_deaths.json')\n  .defer(d3.json, dataDir+'state_income.json')\n  .defer(d3.json, dataDir+'state_unemployment.json')\n  .defer(d3.json, dataDir+'drug_use.json')\n  .await(loadData);\n  \n// globals for data\nfunction loadData(error, topo, deaths, income, unemployment, drugUse) {\n  if (error) {\n    console.log(error);\n  } else {\n    topo.objects.usa.geometries.sort(function(a,b) {\n      if (a.id < b.id) return -1;\n      if (a.id > b.id) return 1;\n      return 0;\n    });\n    \n    // convert death data from strings to numbers and dates\n    deaths.forEach(function(state) {\n      state.years.forEach(function(year) {\n        year.death_rate = +year.death_rate;\n        year.deaths = +year.deaths;\n        year.population = +year.population;\n        year.year = parseYear(year.year);\n      });\n    });\n    // convert income data from strings to numbers and dates\n    income.forEach(function(state) {\n      state.years.forEach(function(year) {\n        year.median_income = +year.median_income / 1000,\n        year.year = parseYear(year.year)\n      });\n    });\n    \n    unemployment.forEach(function(state) {\n      state.years.forEach(function(year) {\n        year.unemployment = +year.unemployment;\n        year.year = parseYear(year.year);\n      })\n    })\n    // update data loading status\n    dataLoaded = true;\n    // create visualizations\n    createVis(topo, deaths, income, unemployment, drugUse);\n  }\n}\n\n/***--------------------------------***\n *** DRAW AND UPDATE VISUALIZATIONS ***\n ***--------------------------------***/\n\nvar handler = new EventHandler();\nd3.select(window).on('resize', function() {handler.broadcast({name: 'resize'});});\nd3.select('#switch-view-button').on('click', function() {handler.broadcast({name: 'switchView'});});\n\n// creates and initializes all visualizations \nfunction createVis(topo, deaths, income, unemployment, drugUse) {\n  \n  choropleth = new Choropleth('choropleth', topo, deaths);\n  choropleth.eventHandler(handler).initVis();\n  \n  scatterplot = new Scatterplot('scatterplot', 'median_income', deaths, income, unemployment);\n  scatterplot.eventHandler(handler).initVis();\n  \n  yearSlider = new YearSlider('year-slider', [2002, 2014]);\n  yearSlider.eventHandler(handler).initVis();\n  handler.on('question-clicked', this, displaySliderDescription);\n  \n  treemap = new Treemap('treemap-area', drugUse);\n  treemap.eventHandler(handler).initVis();\n  \n  singleYearSlider = new SingleYearSlider('single-year-slider', [2003, 2013]);\n  singleYearSlider.eventHandler(handler).initVis();\n  \n  drugTypes = drugUse.children.map(function(d) { return d.name; }).reverse();\n  drugTypeLegend = new DrugTypeLegend('drug-type-legend', drugTypes);\n  drugTypeLegend.eventHandler(handler).initVis();\n}\n\n// update visualizations based on selected options\nfunction updateFactor(factor) {\n  if (dataLoaded) {\n    // build options\n    options = {\n      factor: factor,\n      duration: 1000\n    };\n    \n    handler.broadcast({ name: 'update', options: options});\n  }\n}\n\nfunction displaySliderDescription() {\n  $('#slider-modal').modal();\n}\n/*--------------------*\n *** INITIALIZATION ***\n *--------------------*/\n\n/**\n * Creates a new choropleth\n *\n * @param parentElem  The dom element within which the visualization should be\n *                    appended\n * @param topo        The topojson data for the choropleth's map\n * @param data        The death data with which to color the map\n * @return Choropleth\n */\nfunction Choropleth(parentElem, topo, data) {\n  this.parentElem = parentElem;\n  this.topo = topo;\n  this.data = data;\n  this.displayData = {};\n  \n  this.sizeGroup = \"medium\";\n  this.default = {\n    duration: 1000\n  };\n}\n\n/**\n * If an event handler is specified sets the choropleth's handler and adds \n * the choropleth's listener callbacks. Returns the choropleth\n * If no event handler is specified returns the choropleth's current handler.\n *\n * @param handler The event handler to use with the choropleth\n * @return Choropleth|EventHandler\n */\nChoropleth.prototype.eventHandler = function(handler) {\n  if (handler) {\n    this._eventHandler = handler;\n    this._eventHandler.on('update', this, this.handleUpdate);\n    this._eventHandler.on('resize', this, this.handleResize);\n    this._eventHandler.on('mouseoverState', this, this.drawHighlight);\n    this._eventHandler.on('mouseoutState', this, this.removeHighlight);\n    return this;\n  }\n  \n  return this._eventHandler;\n}\n\n/**\n * Creates SVG and initializes visualization variables.\n *\n * @return Choropleth\n */\nChoropleth.prototype.initVis = function() {\n  var vis = this;\n  \n  /* DRAWING PARAMETERS */\n  vis.margin = { top: 40, right: 20, bottom: 20, left: 20 };\n  vis.keyHeight = 80;\n  vis.keyRectHeight = 20;\n  \n  /* ** CREATE DRAWING AREA ** */\n  vis.svg = d3.select('#'+vis.parentElem).append('svg')\n    .classed('us-map', true);\n  vis.graph = vis.svg.append('g');\n  vis.key = vis.svg.append('g').classed('key', true);\n  vis.keyTitle = vis.key.append('text')\n    .text('Deaths Per 100,000')\n    .classed('key-title', true)\n    .attr('text-anchor', 'middle');\n      \n  /*** MAP DRAWING FUNCTIONS ***/\n  vis.projection = d3.geo.albersUsa();\n  vis.path = d3.geo.path()\n    .projection(vis.projection);\n  \n  vis.resize();\n  // return vis for chaining\n  return vis;\n}\n\n\n/*------------*\n *** SIZING ***\n *------------*/\n\n/**\n * Resizes the visualization and redraws it within its parent element.\n *\n * @return Choropleth\n */\nChoropleth.prototype.resize = function() {\n  var vis = this;\n  \n  /* set width and height based on container */\n  vis.width = parseInt(d3.select('#'+vis.parentElem).style('width')) - vis.margin.left - vis.margin.right;\n  vis.height = vis.width * .8 - vis.margin.top - vis.margin.bottom;\n  vis.sizeGroup = (vis.width > 468) ? 'medium' : 'small';\n  \n  /* update margin transformations */\n  vis.svg.attr('width', vis.width + vis.margin.left + vis.margin.right)\n    .attr('height', vis.height + vis.margin.top + vis.margin.bottom + vis.keyHeight);\n    \n  vis.key.attr('transform', 'translate(0,10)');\n  vis.keyTitle.attr('x', vis.width/2)\n    .attr('y', 10);\n      \n  vis.graph.attr('transform', 'translate('+ vis.margin.left +','+ vis.margin.top +')');\n  \n  /* Rescale drawing parameters */\n  vis.keyWidth = Math.floor((1/6)*vis.width);\n  vis.projection.scale(vis.width * 1.35)\n    .translate([vis.width/2, vis.height/2]);\n    \n  vis.update({ duration: 0 });\n  \n  return vis;\n}\n\n/**\n * Returns the correct offset based on the visualization's current size group\n *\n * @return Number\n */\nChoropleth.prototype.keyLabelOffset = function() {\n  if (this.sizeGroup == 'medium') {\n    return 55;\n  } else {\n    return 50;\n  }\n}\n\n/**\n * Returns the correct font size based on the visualizations current size group\n *\n * @return String\n */\nChoropleth.prototype.fontSize = function() {\n  if (this.sizeGroup == \"medium\") {\n    return '14px';\n  } else {\n    return '12px';\n  }\n}\n\n/*---------------------------*\n *** DRAWING VISUALIZATION ***\n *---------------------------*/\n \n/**\n * Coerces data into an array the state's ID and death rate.\n * Accepted Options:\n *  years: Array of date objects, first date should be the year for death rate \n *\n * @param options The options for wrangling data\n */\nChoropleth.prototype.wrangleData = function(options) {\n  var vis = this;\n  if (!options || !options.years) {\n    vis.deathRateYear = parseYear('2014');\n  } else {\n    vis.deathRateYear = options.years[0];\n  }\n  \n  // empty object to hold filtered data\n  vis.displayData = vis.data.map(function(state) {\n    // filter out years falling beyond given date range\n    return {\n      id: state.id,\n      death_rate: state.years.reduce(function(prev, year) {\n        return prev + (year.year.getTime() == vis.deathRateYear.getTime() ? year.death_rate : 0);\n      }, 0)\n    };\n  });\n}\n\n\n/**\n * Updates the visualization according to the new data year\n * Accepted Options:\n *  years:    An array of year objects where the first year corresponds with \n *            death rate data\n *  duration: The duration (in milliseconds) that transitions should last\n *\n * @param options Options for redrawing the visualization \n * @return Choropleth\n */\nChoropleth.prototype.update = function(options) {\n  var vis = this;\n  vis.wrangleData(options);\n  \n  var duration = options.duration ? options.duration : vis.default.duration;\n  // change colors domain\n  stateColors.domain([0, 1, 5, 10, 15, 20]);\n  \n  vis.keyTitle.html('Deaths Per 100,000 <tspan class=\"death-rate-year\">('+ \n    formatYear(vis.deathRateYear) +')</tspan>');\n  \n  var keyRects = vis.key.selectAll('rect').data(stateColors.domain());\n  keyRects.enter().append('rect')\n    .classed('key-rect', true);\n  keyRects.transition().duration(duration)\n    .attr('x', function(d, i) { return i * vis.keyWidth; })\n    .attr('y', vis.keyRectHeight)\n    .attr('width', vis.keyWidth)\n    .attr('height', vis.keyRectHeight)\n    .attr('fill', function(d) { return stateColors(d); });\n  \n  var keyLabels = vis.key.selectAll('.key-label').data(stateColors.domain())\n  keyLabels.enter().append('text')\n    .classed('key-label', true);\n  keyLabels.transition().duration(duration)\n    .text(function(d, i) { \n      if (i == stateColors.domain().length - 1) return d +'+';\n      return d; \n    })\n    .attr('x', function(d,i) { return i * vis.keyWidth + 2;})\n    .attr('y', vis.keyLabelOffset())\n    .attr('font-size', vis.fontSize());\n    \n  \n  vis.states = vis.graph.selectAll('path')\n    .data(topojson.feature(vis.topo, vis.topo.objects.usa).features);\n  vis.states.enter()\n    .append('path')\n      .classed('state', true)\n      .on('mouseover', function(d) { vis.highlightState(d); })\n      .on('mouseout', function(d) { vis.unhighlightState(d); });\n  vis.states.transition().duration(duration)\n    .attr('d', vis.path)\n    .attr('fill', function(d, i) { \n      return stateColors(vis.displayData[i].death_rate); });\n  \n  return vis;\n}\n\n\n/*--------------------*\n *** EVENT HANDLERS ***\n *--------------------*/\n\n/**\n * Responds to resize events by calling the visualization's resize method\n */\nChoropleth.prototype.handleResize = function(event) {\n  this.resize();\n}\n\n/**\n * Handles update events by calling the visualizations update method\n */\nChoropleth.prototype.handleUpdate = function(event) {\n  this.update(event.options);\n}\n\n/**\n * Draws a highlight around the given state and broadcasts the highlight event\n *\n * @param d The state topojson path that triggered the highlight event\n */\nChoropleth.prototype.highlightState = function(d) {\n  this.drawHighlight(d).eventHandler().broadcast({ name: 'mouseoverState', id: d.id }, this);\n}\n\n/**\n * Removes the highlight from the given state and broadcasts the unhighlight \n * event\n *\n * @param d The state topojson path that triggered the unhighlight event\n */\nChoropleth.prototype.unhighlightState = function(d) {\n  this.removeHighlight(d).eventHandler().broadcast({ name: 'mouseoutState', id: d.id }, this);\n}\n\n/**\n * Draws a red ring around the highlighted state\n *\n * @param d The path of the state being highlighted\n * @return Choropleth\n */\nChoropleth.prototype.drawHighlight = function(d) {\n  var vis = this;\n  vis.states.filter(function(state) { return state.id == d.id})\n    .classed('highlighted', true);\n  return vis;\n}\n\n/**\n * Removes the red ring from the unhighlighted state\n *\n * @param d The path of the state having its highlight removed\n * @return Choropleth\n */\nChoropleth.prototype.removeHighlight = function(d) {\n  var vis = this;\n  this.states.filter(function(state) { return state.id == d.id; })\n    .classed('highlighted', false);\n  return vis;\n}\n\n\n\nfunction DrugTypeLegend(parentElem, types) {\n  this.parentElem = parentElem;\n  this.types = types;\n}\n\nDrugTypeLegend.prototype.eventHandler = function(eventHandler) {\n  if (eventHandler) {\n    this._eventHandler = eventHandler;\n    this._eventHandler.on('resize', this, this.handleResize);\n    \n    return this;\n  }\n  \n  return this._eventHandler;\n}\n\nDrugTypeLegend.prototype.initVis = function() {\n  var vis = this;\n    \n  vis.svg = d3.select('#'+vis.parentElem).append('svg');\n  vis.legend = vis.svg.append('g').classed('legend', true);\n  \n  vis.resize();\n}\n\nDrugTypeLegend.prototype.handleResize = function(event) {\n  this.resize();\n}\n\nDrugTypeLegend.prototype.resize = function() {\n  var vis = this;\n  vis.margin = {top: 10, right: 100, bottom: 10, left: 100};\n  vis.width = parseInt(d3.select('#'+vis.parentElem).style('width')) - vis.margin.left - vis.margin.right,\n  vis.height = 50 - vis.margin.top - vis.margin.bottom;\n  \n  vis.svg\n    .attr(\"width\", vis.width + vis.margin.left + vis.margin.right)\n    .attr(\"height\", vis.height + vis.margin.top + vis.margin.bottom);\n  \n  vis.legend.attr(\"transform\", \"translate(\" + vis.margin.left + \",\" + vis.margin.top + \")\");\n  \n  vis.update();\n}\n\nDrugTypeLegend.prototype.update = function() {\n  var vis = this;\n  \n  var elementWidth = vis.width/vis.types.length;\n  var elements = vis.legend.selectAll(\"g\").data(vis.types);\n  var elementsEnter = elements.enter().append(\"g\")\n    .attr(\"class\", \"legend\")\n    .attr('width', elementWidth);\n\n  elementsEnter.append('rect');\n  elementsEnter.append('text')\n    .attr(\"dy\", \".35em\")\n    .attr(\"text-anchor\", \"middle\");\n  \n  elements\n    .attr('transform', function(d,i) {\n      return 'translate('+ (i * elementWidth) +',0)';\n    });\n    \n  elements.selectAll('rect')\n    .attr(\"width\", 10)\n    .attr(\"height\", 10)\n    .attr('x', (elementWidth/2) - 5)\n    .style(\"fill\", function(d) { return drugColors(d); });\n\n  elements.selectAll('text')\n    .text(function(d) { return d.replace('_', ' '); })\n    .attr(\"x\", elementWidth/2)\n    .attr(\"y\", 30);\n}\n\n\n/**\n * Creates a new EventHanlder object\n *\n * @return EventHandler\n */\nfunction EventHandler() {\n  this.listeners = {};\n}\n\n/**\n * Adds an event listener for events with the given name. Note that\n * this method does not check for uniqueness. If a listener registers\n * for an event multiple times it will receive multiple notifications\n * when the event occurs.\n *\n * @param eventName   The name of the event being listened for\n * @param listener    The object interested in listening for the event\n * @param callback    The callback for handling the event, which is passed\n *                    to the callback as the only parameter\n *\n * @return EventHandler\n */\nEventHandler.prototype.on = function(eventName, listener, callback) {\n  var listeners = this.listeners[eventName];\n  if (!listeners) {\n    listeners = [];\n  }\n  listeners.push({listener: listener, callback: callback.bind(listener)});\n  this.listeners[eventName] = listeners;\n  \n  return this;\n}\n\n/**\n * Informs all interested listeners of the occurrence of a given event. \n * If the caller provides a value for sender, the sender will not be \n * informed of the event.\n *\n * @param event   An object containing important event properties. \n *                'name' is the only required property.\n * @param sender  (Optional) The object that broadcast the event. If \n *                specified then the sender will not have any of its\n *                callbacks fired.\n *\n * @return EventHandler\n */\nEventHandler.prototype.broadcast = function(event, sender) {\n  var listeners = this.listeners[event.name];\n  if (listeners) {\n    listeners.forEach(function(listener) {\n      if (listener.listener != sender) {\n        listener.callback(event);\n      }\n    });\n  }\n  return this;\n}\n\n// code found at http://bl.ocks.org/benvandyke/8459843\nfunction Regression() {\n  this.xSeries = function(xSeries) {\n    if (!xSeries) {\n      return this._xSeries;\n    }\n    \n    this._xSeries = xSeries;\n    return this;\n  };\n  \n  this.ySeries = function(ySeries) {\n    if (!ySeries) {\n      return this._ySeries;\n    }\n    \n    this._ySeries = ySeries;\n    return this;\n  };\n  \n  this.reduceSum = function(prev, cur) {\n    return prev + cur;\n  };\n  \n  this.coefficients = function() {\n    var self = this;\n    var xBar = this._xSeries.reduce(this.reduceSum) * 1.0 / this._xSeries.length;\n    var yBar = this._ySeries.reduce(this.reduceSum) * 1.0 / this._ySeries.length;\n\n    var ssXX = this._xSeries.map(function(d) { return Math.pow(d - xBar, 2); })\n      .reduce(this.reduceSum);\n    \n    var ssYY = this._ySeries.map(function(d) { return Math.pow(d - yBar, 2); })\n      .reduce(this.reduceSum);\n      \n    var ssXY = this._xSeries.map(function(d, i) { return (d - xBar) * (self._ySeries[i] - yBar); })\n      .reduce(this.reduceSum);\n      \n    var slope = ssXY / ssXX;\n    var intercept = yBar - (xBar * slope);\n    var rSquare = Math.pow(ssXY, 2) / (ssXX * ssYY);\n    \n    return [slope, intercept, rSquare];\n  };\n}\n\n/*--------------------*\n *** INITIALIZATION ***\n *--------------------*/\n\n/**\n * Creates a new Scatterplot visualization\n *\n * @param parentElem    The ID of the DOM element within which the visualization\n *                      should be drawn.\n * @param handler       The event handler for the visualization\n * @param deaths        An array of death data sorted alphabetically by state\n * @param income        An array of income data sorted alphabetically by state\n * @param unemployment  An array of unemployment data sorted alphabetically by \n *                      state\n * @return Scatterplot\n */\nfunction Scatterplot(parentElem, factor, deaths, income, unemployment) {\n  this.parentElem = parentElem;\n  this.data = {\n    'death_rate': {\n      data: deaths,\n      name: 'Deaths Per 100,000',\n      format: formatIdentity,\n      domain: [\n        d3.min(deaths, function(d) { return d3.min(d.years, function(d) {return d.death_rate; }); }),\n        d3.max(deaths, function(d) { return d3.max(d.years, function(d) {return d.death_rate; }); })\n      ]\n    },\n    'median_income': {\n      data: income,\n      name: 'Median Income (1000s)',\n      shortName: 'Median Income',\n      format: formatCurrency,\n      domain: [\n        d3.min(income, function(d) { return d3.min(d.years, function(d) {return d.median_income; }); }),\n        d3.max(income, function(d) { return d3.max(d.years, function(d) {return d.median_income; }); })\n      ]\n    },\n    'unemployment': {\n      data: unemployment,\n      name: 'Unemployment Rate',\n      shortName: 'Unemployment Rate',\n      format: formatPercent,\n      domain: [\n        d3.min(unemployment, function(d) { return d3.min(d.years, function(d) {return d.unemployment; }); }),\n        d3.max(unemployment, function(d) { return d3.max(d.years, function(d) {return d.unemployment; }); })\n      ]\n    }\n  };\n  \n  this.factor = factor;\n  this.factorYear = parseYear('2014');\n  this.deathRateYear = parseYear('2014');\n  \n  this.displayData = {};\n  this.regression = new Regression();\n  \n  this.sizeGroup = \"medium\";\n  this.default = {\n    duration: 1000\n  }\n}\n\n/**\n * If a handler is specified the Scatterplot updates its event handler and \n * registers listeners for the events for which it's interested. The receiving\n * object is returned.\n * If no handler is given returns the objects current handler.\n *\n * @param handler (Optional) The event handler for the object\n * @return EventHandler|Scatterplot\n */\nScatterplot.prototype.eventHandler = function(handler) {\n  if (handler) {\n    this._eventHandler = handler;\n    this._eventHandler.on('update', this, this.handleUpdate);\n    this._eventHandler.on('resize', this, this.handleResize);\n    this._eventHandler.on('mouseoverState', this, this.drawHighlight);\n    this._eventHandler.on('mouseoutState', this, this.removeHighlight);\n  \n    return this;\n  }\n  return this._eventHandler;\n}\n\n/**\n * Initalizes the visualization by appending and sizing the containing SVG \n * before defining scales and axes. Should only be called once on a given \n * scatter plot.\n *\n * @return Scatterplot\n */\nScatterplot.prototype.initVis = function() {\n  // grab reference to self\n  var vis = this;\n  \n  /*** SVG DRAWING AREA ***/\n  vis.margin = {top: 20, right: 20, bottom: 40, left: 50};\n  vis.padding = {x: 10, y: 10};\n      \n  vis.svg = d3.select('#'+vis.parentElem).append('svg');\n  vis.graph = vis.svg.append('g');\n  \n  vis.title = vis.graph.append('text')\n    .text('What Factors Influence Drug Deaths?')\n    .attr('text-anchor', 'middle')\n    .attr('font-weight', 'bold');\n      \n  /*** CHART DATA ELEMENTS ***/\n  vis.scatter = vis.graph.append('g')\n    .classed('scatter-plot', true);\n    \n  vis.bfl = vis.graph.append('g')\n    .classed('best-fit', true);\n    \n  vis.x = d3.scale.linear();\n  vis.y = d3.scale.linear();\n    \n  /*** CHART AXES ***/\n  vis.xAxisG = vis.graph.append('g')\n    .classed('axis x-axis', true);\n    \n  vis.yAxisG = vis.graph.append('g')\n    .classed('axis y-axis', true);\n    \n  vis.xAxis = d3.svg.axis()\n    .scale(vis.x)\n    .ticks(6)\n    .orient('bottom');\n    \n  vis.yAxis = d3.svg.axis()\n    .scale(vis.y)\n    .orient('left');\n    \n  vis.xTitle = vis.xAxisG.append('text')\n    .classed('axis-label', true)\n    .attr('text-anchor', 'middle');\n    \n  vis.yTitle = vis.yAxisG.append('text')\n    .classed('axis-label', true)\n    .attr('transform', 'rotate(-90)')\n    .attr('text-anchor', 'middle')\n    .text('Deaths per 100,000');\n    \n  vis.stateTip = d3.tip()\n    .attr('class', 'd3-tip')\n    .direction('s')\n    .offset([5,0])\n    .html(function(d) {\n      return ''+\n        '<h4>'+ d.id +'</h4><p>'+\n          '<span class=\"tip-header\">Death Rate: <span class=\"death-rate\">'+ \n            d.death_rate +'</span></span><br>'+\n          '<span class=\"tip-header\">'+ vis.data[vis.factor].name +\n            ': <span class=\"factor\">'+ vis.data[vis.factor].format(d.factor) +'</span></span></p>';\n    });\n  vis.graph.call(vis.stateTip);\n  \n  vis.bflTip = d3.tip()\n    .attr('class', 'd3-tip')\n    .direction('s')\n    .offset([5,0])\n    .html(function(d) {\n      return ''+\n        '<span class=\"tip-header\">Death Rate <span class=\"tip-death-rate\">('\n          + formatYear(vis.deathRateYear) +')</span></span><br>'+\n        '<span class=\"tip-header\">'+ vis.data[vis.factor].shortName +\n          ' <span class=\"tip-factor\">('+ formatYear(vis.factorYear) +')</span></span><br>'+\n        '<span class=\"tip-header\">Correlation: '+ d.correlation.toFixed(2) +'</span>'+\n        '<span class=\"more-info\">Click for detailed information</span>';\n    });\n  vis.graph.call(vis.bflTip);\n  \n  vis.resize();\n  \n  // return vis for chaining\n  return vis;\n}\n\n/*------------*\n *** SIZING ***\n *------------*/\n\nScatterplot.prototype.labelFontSize = function() {\n  if (this.sizeGroup == 'medium') return '10pt'; \n  return '8pt';\n}\n\nScatterplot.prototype.yAxisTicks = function() {\n  if (this.sizeGroup == 'medium') return 10;\n  return 4;\n}\n\n/**\n * Resizes the visualization according to its parent within the DOM. \n *\n * @return Scatterplot\n */\nScatterplot.prototype.resize = function() {\n  var vis = this;\n  \n  // grab width of current container\n  vis.width = parseInt(d3.select('#'+vis.parentElem).style('width')) - vis.margin.left - vis.margin.right;\n  vis.height = vis.width;\n  \n  // update size group\n  vis.sizeGroup = (vis.width > 256) ? 'medium' : 'small';\n    \n  // resize svg, reset margin\n  vis.svg.attr('width', vis.width + vis.margin.left + vis.margin.right)\n    .attr('height', vis.height + vis.margin.top + vis.margin.bottom);\n  vis.graph.attr('transform', 'translate('+ vis.margin.left +','+ vis.margin.top +')');\n  \n  vis.title.attr('x', vis.width/2)\n    .attr('y', 6)\n    .attr('font-size', vis.labelFontSize());\n  // change scale drawing range\n  vis.x.range([vis.padding.x, vis.width-vis.padding.x]);\n  vis.y.range([vis.height-vis.padding.y, vis.padding.y]);\n  // update axis offests and title positions\n  vis.xAxisG.attr('transform', 'translate(0, '+ vis.height +')');\n  vis.xTitle.attr('x', vis.width/2)\n    .attr('y', vis.margin.bottom-2);\n    \n  vis.yAxis.ticks(vis.yAxisTicks());\n  vis.yTitle.attr('x', -vis.width/2)\n    .attr('y', -vis.margin.left * (3/4) );\n  \n  // update vis with default options now that svg has been resized\n  vis.update(vis.default);\n  \n  // return vis for chaining\n  return vis;\n}\n\n\n/*---------------------------*\n *** DRAWING VISUALIZATION ***\n *---------------------------*/\n\n/**\n * Filters the visualizations data by year according to the given options \n * Accepted Options:\n *  year: The year for which to show data on the x axis\n *\n * @param options (Optional) An object containing options for manipulating data \n * @return Scatterplot\n */\nScatterplot.prototype.wrangleData = function(options) {\n  var vis = this;\n  \n  if (!options) {\n    // create local shadow variable so shared object doesn't change\n    var options = {};\n  }\n  \n  vis.deathRateYear = options.years ? options.years[0] : vis.deathRateYear; \n  vis.factorYear = options.years ? options.years[1] : vis.factorYear;\n  vis.factor = options.factor ? options.factor : vis.factor;\n  \n  // wrangled data is placed into variable displayData\n  vis.displayData = vis.data[vis.factor].data.reduce(function(prev, current, i) {\n    // skip any national data\n    if (current.id === 'United States') {\n      return prev;\n    }\n    \n    // grab corresponding state death and factor data\n    var deaths = vis.data['death_rate'].data[i];\n    var factorData = vis.data[vis.factor].data[i];\n    \n    // get data only from specified year\n    deathYearData = deaths.years.filter(function(y) { \n      return y.year.getTime() == vis.deathRateYear.getTime(); })[0];\n    factorYearData = factorData.years.filter(function(y) {\n      return y.year.getTime() == vis.factorYear.getTime(); })[0];\n    \n    // add an object with the state's data to the array\n    prev.push({\n      id: current.id,\n      death_rate: deathYearData.death_rate,\n      factor: factorYearData[vis.factor]\n    });\n    return prev; \n  }, []);\n  \n  // return vis for chaining\n  return vis;\n}\n\n/**\n * Updates the visualization by updating display data according to the given\n * options and redrawing the scatterplot accordingly.\n * Accepted Options:\n *  year: The year to use when drawing the x axis (default is most recent)\n *  duration: The duration of any trasnitions (default is 0)\n *\n * @param options The options for updating the scatterplot.\n * @return Scatterplot\n */\nScatterplot.prototype.update = function(options) {\n  var vis = this;\n  \n  // update display data\n  vis.wrangleData(options);\n  \n  var duration = options.duration ? options.duration : vis.default.duration;\n  // update x and y domains according to new data\n  vis.x.domain(vis.data[vis.factor].domain);\n  vis.y.domain([0, 35]);\n  \n  // redraw axes\n  vis.xTitle\n    .html(vis.data[vis.factor].name +\n      ' <tspan class=\"factor\">('+ formatYear(vis.factorYear) +')</tspan>')\n    .attr('font-size', vis.labelFontSize());\n    \n  vis.yTitle\n    .html(vis.data.death_rate.name +\n      ' <tspan class=\"death_rate\">('+ formatYear(vis.deathRateYear) +')</tspan>')\n    .attr('font-size', vis.labelFontSize());\n  \n  vis.xAxis.tickFormat(vis.data[vis.factor].format);\n  vis.xAxisG.transition().duration(duration)\n    .call(vis.xAxis);\n  vis.yAxisG.transition().duration(duration)\n    .call(vis.yAxis);\n  // update scatter plot dots data\n  vis.dots = vis.scatter.selectAll('circle').data(vis.displayData);\n  // draw any new dots \n  vis.dots.enter()\n    .append('circle')\n      .attr('class', function(d) { return 'dot '+d.id.replace(' ', ''); })\n      .attr('r', 5)\n      .on('mouseover', vis.highlightState.bind(vis))\n      .on('mouseout', vis.unhighlightState.bind(vis));\n  // move existing dots into new position according to display data  \n  vis.dots.transition().duration(duration)\n    .attr('cx', function(d) { return vis.x(d.factor); })\n    .attr('cy', function(d) { return vis.y(d.death_rate); })\n    .attr('fill', function(d) { return stateColors(d.death_rate)});\n      \n  // get variables to pass to regression calculator\n  var xSeries = vis.displayData.map(function(d) { return d.factor; });\n  var ySeries = vis.displayData.map(function(d) { return d.death_rate;});\n  var coeff = vis.regression.xSeries(xSeries)\n    .ySeries(ySeries)\n    .coefficients();\n  \n  // calculate best fit line path\n  var bflData = [{x1: vis.x.domain()[0], y1: coeff[1],\n                  x2: vis.x.domain()[1], y2: coeff[0] * vis.x.domain()[1] + coeff[1],\n                  correlation: Math.sqrt(coeff[2])}];\n  vis.regLine = vis.bfl.selectAll('line').data(bflData);\n  // append best fit line (if necessary) or redraw with new data\n  vis.regLine.enter().append('line')\n    .classed('best-fit', true)\n    .on('mouseover', function(d) { vis.highlightBFL(d); })\n    .on('mouseout', function(d) { vis.unhighlightBFL(d); });\n  vis.regLine.transition().duration(duration)\n    .attr('x1', function(d) { return vis.x(d.x1); })\n    .attr('y1', function(d) { return vis.y(d.y1); }) \n    .attr('x2', function(d) { return vis.x(d.x2); })\n    .attr('y2', function(d) { return vis.y(d.y2); });\n}\n\n/*--------------------*\n *** EVENT HANDLERS ***\n *--------------------*/\n\n/**\n * Handles 'resize' events by calling the visualizations resize method. \n *\n * @param event The event object\n */\nScatterplot.prototype.handleResize = function(event) {\n  this.resize();\n}\n \n/**\n * Handles 'update' events by calling the visualizations 'update' method\n *\n * @param event The event object created by the object that fired the event\n */\nScatterplot.prototype.handleUpdate = function(event) {\n  this.update(event.options);\n}\n\n\n/**\n * Draws a red ring around highlighted dot and increases its size\n *\n * @return Scatterplot\n */\nScatterplot.prototype.drawHighlight = function(d) {\n  var vis = this;\n  vis.dots.filter(function(state) { return state.id == d.id; })\n    .classed('highlighted', true)\n    .attr('r', 10);\n  vis.stateTip.show(vis.displayData[vis.stateIndex(d)]);\n  // return vis for chaining\n  return vis;\n}\n\n/**\n * Removes red ring around highlighted state and reduces its size back to the \n * starting amount.\n *\n * @return Scatterplot\n */\nScatterplot.prototype.removeHighlight = function(d) {\n  var vis = this;\n  vis.dots.filter(function(state) { return state.id == d.id; })\n    .classed('highlighted', false)\n    .attr('r', 5);\n  vis.stateTip.hide();\n  // return vis for chaining\n  return vis;\n}\n\nScatterplot.prototype.highlightBFL = function(d) {\n  this.regLine.classed('highlighted', true);\n  this.bflTip.show(d);  \n}\n\nScatterplot.prototype.unhighlightBFL = function(d) {\n  this.regLine.classed('highlighted', false);\n  this.bflTip.hide();\n}\n\n/**\n * Draws highlight around selected state and broadcasts event \n *\n * @param d The dot of the state being highlighted\n */\nScatterplot.prototype.highlightState = function(d) {\n  this.drawHighlight(d).eventHandler().broadcast({ name: 'mouseoverState', id: d.id }, this);\n}\n\n/**\n * Removes highlight from deselected state and broadcasts event\n *\n * @param d The dot of the state having its highlight removed\n */\nScatterplot.prototype.unhighlightState = function(d) {\n  this.removeHighlight(d).eventHandler().broadcast({ name: 'mouseoutState', id: d.id }, this);\n}\n\nScatterplot.prototype.stateIndex = function(d) {\n  for (var i = 0; i < this.displayData.length; i++) {\n    if (this.displayData[i].id == d.id) return i;\n  }\n  return 0;\n}\n\nfunction SingleYearSlider(parentElem, years) {\n  this.parentElem = parentElem;\n  this.years = years;\n}\n\nSingleYearSlider.prototype.eventHandler = function(eventHandler) {\n  if (eventHandler) {\n    this._eventHandler = eventHandler;\n    \n    return this;\n  }\n  \n  return this._eventHandler;\n}\n\nSingleYearSlider.prototype.initVis = function() {\n  var vis = this;\n  \n  vis.svg = d3.select('#'+vis.parentElem).append(\"svg\");\n  vis.graph = vis.svg.append('g')\n    .attr(\"class\", \"slider\")\n\n  vis.x = d3.scale.linear()\n    .domain(vis.years)\n    .clamp(true);\n\n  vis.brush = d3.svg.brush()\n    .x(vis.x)\n    .on(\"brush\", function() {vis.brushed();});\n\n  vis.background = vis.graph.append(\"rect\")\n      .attr(\"class\", \"slider_background\");\n      \n  vis.xAxis = d3.svg.axis()\n    .scale(vis.x)\n    .orient(\"bottom\")\n    .tickFormat(function (d) { return +d; })\n    .tickSize(0)\n    .tickPadding(12)\n    \n  vis.graph.append(\"g\")\n    .attr(\"class\", \"x axis\")\n    .select(function () { return this.parentNode.appendChild(this.cloneNode(true)); })\n    .attr(\"class\", \"halo\");\n\n  vis.slider = vis.graph.append(\"g\")\n    .attr(\"class\", \"slider\")\n    .call(vis.brush);\n\n  vis.handle = vis.slider.append(\"circle\")\n    .attr(\"class\", \"handle\")\n    .attr(\"r\", 9);\n    \n  vis.resize();\n}\n\nSingleYearSlider.prototype.resize = function(options) {\n  var vis = this;\n  \n  vis.margin = { top: 10, left: 100, right: 100, bottom: 0};\n  vis.width = parseInt(d3.select('#'+vis.parentElem).style('width')) - vis.margin.left - vis.margin.right,\n  vis.height = 50 - vis.margin.top - vis.margin.bottom;\n  vis.svg\n    .attr(\"width\", vis.width + vis.margin.right + vis.margin.left)\n    .attr(\"height\", vis.height + vis.margin.top + vis.margin.bottom)\n    \n  vis.x.range([0, vis.width]);\n  \n  vis.graph.attr(\"transform\", \"translate(\" + vis.margin.left + \",\" + vis.margin.top + \")\");\n  vis.graph.call(vis.xAxis);\n  \n  vis.background\n    .attr(\"height\", 4)\n    .attr(\"width\", vis.width);\n    \n  vis.slider.select(\".background\")\n    .attr(\"height\", 100);\n    \n  vis.update({ year:vis.years[vis.years.length-1] });\n}\n\nSingleYearSlider.prototype.update = function(options) {\n  var vis = this;\n  \n  var year = options.year;\n  \n  vis.slider\n    .call(vis.brush.event)\n    .transition()\n    .duration(750)\n    .call(vis.brush.extent([2013, 2013]))\n    .call(vis.brush.event);\n}\n\nSingleYearSlider.prototype.brushed = function() {\n  var vis = this;\n  var value = Math.round(vis.brush.extent()[0]);\n  if (d3.event.sourceEvent) { // not a programmatic event\n    value = Math.round(vis.x.invert(d3.event.sourceEvent.x - vis.margin.left));\n    this.eventHandler().broadcast({ name:'updateDrugs', year:value}, vis);\n  }\n\n  vis.handle.attr(\"cx\", vis.x(value));\n}\n\nfunction loadStackedArea(){\n\n    var margin = {top: 10, right: 100, bottom: 30, left: 100},\n        width = parseInt(d3.select('#treemap-area').style('width')) - margin.left - margin.right,\n        height = width * .55 - margin.top - margin.bottom;\n\n    var parseDate = d3.time.format(\"%Y\").parse,\n        formatPercent = d3.format(\".0%\");\n\n    var x = d3.time.scale()\n        .range([0, width]);\n\n    var y = d3.scale.linear()\n        .range([height, 0]);\n\n    var axisYScale = d3.scale.linear()\n        .domain([0, 2100000])\n        .range([height, 0]);\n\n\n    var color = d3.scale.category20();\n\n    var xAxis = d3.svg.axis()\n        .scale(x)\n        .orient(\"bottom\");\n\n    var yAxis = d3.svg.axis()\n        .orient(\"left\")\n        .scale(axisYScale)\n        .tickFormat(d3.format(\",.0f\"));\n\n\n    var area = d3.svg.area()\n        .x(function(d) { return x(d.date); })\n        .y0(function(d) { return y(d.y0); })\n        .y1(function(d) { return y(d.y0 + d.y); });\n\n    var stack = d3.layout.stack()\n        .values(function(d) { return d.values; });\n\n    var title = d3.select(\"#tree-title\");\n    title.selectAll(\"*\").remove();\n    title\n        .append(\"h3\")\n        .text(\"Admission to Drug Treatment Programs by Subtance and Year\");\n    var svg = d3.select(\"#treemap-area\");\n    svg.selectAll(\"*\").remove();\n\n    var legend = d3.select(\"#treemap-area\")\n        .append(\"svg\")\n        .attr(\"class\", \"legend\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height/9)\n        .attr(\"transform\", \"translate(\" + margin.left + \",\" + 0 + \")\");\n\n\n    var svg = d3.select(\"#treemap-area\")\n        .append(\"svg\")\n        .attr(\"width\", width + margin.left + margin.right)\n        .attr(\"height\", height + margin.top + margin.bottom)\n        .append(\"g\")\n        .attr(\"transform\", \"translate(\" + margin.left + \",\" + margin.top + \")\");\n\n    d3.tsv(\"data/treatment2003_2013.tsv\", function(error, data) {\n        if (error) throw error;\n\n        color.domain(d3.keys(data[0]).filter(function(key) { return key !== \"date\"; }));\n\n        data.forEach(function(d) {\n            d.date = parseDate(d.date);\n        });\n\n        var substances = stack(color.domain().map(function(name) {\n            return {\n                name: name,\n                values: data.map(function(d) {\n                    return {date: d.date, y: d[name]/2100000\n                }\n                })\n            };\n        }));\n\n        x.domain(d3.extent(data, function(d) { return d.date; }));\n\n        var legendElements = legend.selectAll(\"g\")\n            .data(substances)\n            .enter().append(\"svg:g\")\n            .attr(\"class\", \"legend\")\n            .attr(\"transform\", \"translate(\" + margin.left + \",\" + 0 + \")\");\n\n        legendElements.append(\"svg:rect\")\n            .attr(\"x\", function(d,i) {\n                return i * (width*0.9)/(substances.length) +25; })\n            .attr(\"y\", 10)\n            .attr(\"width\", 10 )\n            .attr(\"height\", 10 )\n            .style(\"fill\", function(d) { return color(d.name); });\n\n        legendElements.append(\"svg:text\")\n            .attr(\"x\", function(d,i) {\n                return i * (width*0.9)/(substances.length) +30; })\n            .attr(\"y\", 30)\n            .attr(\"dy\", \".35em\")\n            .attr(\"text-anchor\", \"middle\")\n            .text(function(d) { return d.name; });\n\n        var substance = svg.selectAll(\".browser\")\n            .data(substances)\n            .enter().append(\"g\")\n            .attr(\"class\", \"browser\");\n\n        substance.append(\"path\")\n            .attr(\"class\", \"area\")\n            .attr(\"d\", function(d) { return area(d.values); })\n            .style(\"fill\", function(d) { return color(d.name); })\n            .on('mouseover', tip.show)\n            .on('mouseout', tip.hide);\n\n        substance.call(tip);\n\n        svg.append(\"g\")\n            .attr(\"class\", \"x axis\")\n            .attr(\"transform\", \"translate(0,\" + height + \")\")\n            .call(xAxis);\n\n        svg.append(\"g\")\n            .attr(\"class\", \"y axis\")\n            .call(yAxis);\n\n    });\n\n    var tip = d3.tip().attr('class', 'd3-tip').html(function(d) {\n\n        var name = d.name.replace('_', ' ');\n        var number = d.values;\n\n        function makeTable(data){\n            table = \"<tr><td>Year</td><td>Admissions to Treatment</td>\";\n\n            for(var i=0;i<number.length;i++){\n                table += \"<tr>\"+\n                        \"<td>\" + data[i].date.getFullYear() + \"</td>\" +\n                        \"<td>\" + (parseInt(data[i].y*2100000)) + \"</td>\" +\n                    \"</tr>\";\n            }\n            return table;\n        }\n\n        var table = \"<table>\" + \"<th>Substance Type : \"+ name +\"</th>\" + makeTable(number)+ \"</table>\";\n        return table;\n\n    });\n\n\n}\nvar change = true;\n\nfunction changeToOther() {\n    var svg = d3.select(\"#treemap-area\");\n    svg.selectAll(\"*\").remove();\n\n    var title = d3.select(\"#tree-title\");\n    title.selectAll(\"*\").remove();\n\n    if(change){\n        loadStackedArea();\n        change = false;\n    }\n    else{\n        loadTreemap();\n        change = true;\n    }\n}\n\n\n\nfunction Treemap(parentElem, data) {\n  this.parentElem = parentElem;\n  this.treeData = data;\n  this.year_index = data.years[1]-data.years[0];\n}\n\nTreemap.prototype.eventHandler = function(eventHandler) {\n  if (eventHandler) {\n    this._eventHandler = eventHandler;\n    this._eventHandler.on('switchView', this, this.switchView);\n    this._eventHandler.on('resize', this, this.handleResize);\n    this._eventHandler.on('updateDrugs', this, this.handleUpdate);\n    \n    return this;\n  }\n  \n  return this._eventHandler;\n}\n\nTreemap.prototype.switchView = function(event) {\n  var vis = this;\n  var opacity = vis.graph.attr('opacity');\n  opacity = (opacity == 1) ? 0:1;\n  vis.graph.transition().duration(1000)\n    .attr('opacity', opacity);\n}\n\nTreemap.prototype.handleResize = function(event) {\n  console.log('resizing');\n  this.resize();\n}\n\nTreemap.prototype.handleUpdate = function(event) {\n  var vis = this;\n  var year_index = event.year - 2003;\n  if (year_index != vis.year_index) {\n    vis.year_index = event.year - 2003;\n    vis.update();\n  }\n}\n\nTreemap.prototype.initVis = function() {\n  var vis = this;\n  \n  vis.svg = d3.select('#'+vis.parentElem).append('svg');\n  vis.graph = vis.svg.append('g')\n    .classed('chart', true)\n    .attr('opacity', 1);\n  \n  vis.x = d3.scale.linear();\n  vis.y = d3.scale.linear();\n  \n  vis.treemap = d3.layout.treemap()\n    .round(false)\n    .sticky(true)\n    .value(function(d) { return d.size[vis.year_index]; });\n    \n  vis.resize();\n}\n\nTreemap.prototype.resize = function() {\n  var vis = this;\n    \n  vis.margin = {top: 25, right: 100, bottom: 30, left: 100};\n  vis.width = parseInt(d3.select('#'+vis.parentElem).style('width')) - vis.margin.left - vis.margin.right,\n  vis.height = vis.width * .66 - vis.margin.top - vis.margin.bottom,\n  \n  vis.svg\n    .attr('width', vis.width + vis.margin.left + vis.margin.right)\n    .attr('height', vis.height + vis.margin.top + vis.margin.bottom);\n  \n  vis.graph\n    .attr('transform', 'translate('+ vis.margin.left +','+ vis.margin.top +')');\n    \n  vis.treemap.size([vis.width, vis.height]);\n  vis.x.range([0, vis.width]);\n  vis.y.range([0, vis.height]);\n  \n  vis.update();\n}\n\nTreemap.prototype.wrangleData = function(options) {\n  // data needs no wrangling, this function placed here for consistency\n  this.displayData = this.treeData;\n}\n\nTreemap.prototype.update = function(options) {\n  var vis = this;\n  \n  vis.wrangleData(options);\n        \n  var node = vis.displayData;\n  var root = vis.displayData;\n\n  var nodes = vis.treemap.nodes(root)\n      .filter(function(d) { return !d.children; });\n      \n  var cells = vis.graph.selectAll(\".cell\").data(nodes);\n  \n  // Enter\n  var cellsEnter = cells.enter().append(\"g\").attr(\"class\", \"cell\")\n      .on(\"click\", function(d) { return vis.zoom(node == d.parent ? root : d.parent); });\n  cellsEnter.append(\"rect\")\n    .style(\"fill\", function(d) { return drugColors(d.parent.name); });\n  cellsEnter.append(\"text\")\n    .attr(\"dy\", \".35em\")\n    .attr(\"text-anchor\", \"middle\")\n    .text(function(d) { return d.name; })\n  // Update        \n  cells.transition().duration(1000)\n    .attr(\"transform\", function(d) { return \"translate(\" + ( d.x) + \",\" + ( + d.y) + \")\"; })\n  cells.selectAll('rect').transition().duration(1000)\n    .attr(\"width\", function(d) { return d.dx - 1; })\n    .attr(\"height\", function(d) { return d.dy - 1; })\n  cells.selectAll('text').transition().duration(1000)\n    .attr(\"x\", function(d) { return d.dx / 2; })\n    .attr(\"y\", function(d) { return d.dy / 2; })\n    .style(\"opacity\", function(d) { d.w = this.getComputedTextLength(); return d.dx > d.w ? 1 : 0; })\n\n  d3.select(window).on(\"click\", function() { vis.zoom(root); });\n}\n\nTreemap.prototype.zoom = function(d) {\n  var vis = this;\n\n  var kx = (vis.width) / d.dx, ky = (vis.height) / d.dy;\n  vis.x.domain([d.x, d.x + d.dx]);\n  vis.y.domain([d.y, d.y + d.dy]);\n\n  var t = vis.graph.selectAll(\".cell\").transition()\n    .duration(d3.event.altKey ? 7500 : 750)\n    .attr(\"transform\", function (d) {\n        return \"translate(\" + vis.x(d.x ) + \",\" + vis.y(d.y ) + \")\";\n    });\n\n  t.select(\"rect\")\n    .attr(\"width\", function (d) { return kx * d.dx - 1; })\n    .attr(\"height\", function (d) { return ky * d.dy - 1; })\n\n  t.select(\"text\")\n    .attr(\"x\", function (d) { return kx * d.dx / 2; })\n    .attr(\"y\", function (d) { return ky * d.dy / 2; })\n    .style(\"opacity\", function (d) { return kx * d.dx > d.w ? 1 : 0; });\n\n  node = d;\n  //no need to stop propogation on brush events\n  if(d3.event.type != \"brush\"){d3.event.stopPropagation();}\n}\n\nfunction YearSlider(parentElem, range) {\n  this.parentElem = parentElem;\n  this.range = range;\n  this.years = d3.range(range[0], range[1]+1);\n  this.topYear = range[1];\n  this.bottomYear = range[1];\n  \n  this.colors = {\n    markers: {\n      top: {\n        hover: '#756BB1',\n        normal: '#54278F'\n      },\n      bottom: {\n        hover: '#6CD16C',\n        normal: '#23A923' \n      }\n    }\n  };\n}\n\nYearSlider.prototype.question = function(text) {\n  if (text) {\n    this.descriptiveText = text;\n    return this;\n  }\n  \n  return this.descriptiveText;\n}\n\nYearSlider.prototype.eventHandler = function(handler) {\n  if (handler) {\n    this._eventHandler = handler;\n    this._eventHandler.on('resize', this, this.handleResize);\n    \n    return this;\n  }\n  \n  return this._eventHandler;\n}\n\nYearSlider.prototype.initVis = function() {\n  // grab reference to vis\n  var vis = this;\n  \n  /*** SIZES AND SVG ***/\n  vis.margin = { top: 10, right: 20, bottom: 10, left: 20};\n  vis.marker = {radius: 10};\n  vis.axis = {tick: {height: 10}};\n  \n  vis.svg = d3.select('#'+vis.parentElem).append('svg');\n  vis.slider = vis.svg.append('g');\n  \n  /*** SCALE ***/\n  vis.x = d3.scale.linear()\n    .domain(vis.range);\n  \n  /* * DRAWING GROUPS ***/\n  vis.yearsText = vis.slider.append('g').classed('years', true);\n  \n  vis.topSlider = vis.slider.append('g').classed('slider top', true);\n  vis.bottomSlider = vis.slider.append('g').classed('slider bottom', true);\n  \n  vis.topAxis = vis.topSlider.append('g').classed('axis top-axis', true);\n  vis.bottomAxis = vis.bottomSlider.append('g').classed('axis bottom', true);\n    \n  vis.topAxisLine = vis.topAxis.append('line').attr('stroke-width', 4);\n  vis.bottomAxisLine = vis.bottomAxis.append('line').attr('stroke-width', 4);\n  \n  /*** SLIDER TEXT ***/\n  vis.topText = vis.topSlider.append('text')\n    .classed('axis-label top', true)\n    .text('Death Rate')\n    .attr('text-anchor', 'middle');\n  vis.bottomText = vis.bottomSlider.append('text')\n    .classed('axis-label bottom', true)\n    .text('Factor Data')\n    .attr('text-anchor', 'middle');\n  \n  vis.questionButton = vis.slider.append('text')\n    .classed('slider question', true)\n    .html('&#xf29c')\n    .on('click', function(d) {vis.questionClicked();});\n  \n  vis.yearsText.selectAll('text')\n    .data(vis.years).enter()\n    .append('text')\n      .text(function(d) { return d; })\n      .attr('text-anchor', 'middle')\n      .attr('transform', 'rotate(90)')\n  \n  /*** DRAG BEHAVIOR ***/\n  vis.dragTopMarker = d3.behavior.drag()\n    .on('dragstart', function(d) { vis.topMarkerStartedDragging(d); })\n    .on('drag', function(d) { vis.markerDragged(d); })\n    .on('dragend', function(d) { vis.markerEndedDragging(d); });\n  vis.dragBottomMarker = d3.behavior.drag()\n    .on('dragstart', function(d) { vis.bottomMarkerStartedDragging(d); })\n    .on('drag', function(d) { vis.markerDragged(d); })\n    .on('dragend', function(d) { vis.markerEndedDragging(d); });\n  \n  // resize within bounds\n  vis.resize();\n\n  // return vis for chaining\n  return vis;\n}\n\nYearSlider.prototype.resize = function() {\n  // grab reference to vis\n  var vis = this;\n  \n  // update width with new parameters\n  vis.width = parseInt(d3.select('#'+vis.parentElem).style('width')) - vis.margin.left - vis.margin.right;\n  vis.height = (1/3) * vis.width;\n  \n  /*** RESIZE SVG AND MAIN GROUP ***/\n  vis.svg\n    .attr('width', vis.width + vis.margin.left + vis.margin.right)\n    .attr('height', vis.height + vis.margin.top + vis.margin.bottom);\n  vis.slider\n    .attr('transform', 'translate('+ vis.margin.left +','+ vis.margin.top +')');\n    \n  vis.topText.attr('x', vis.width/2)\n    .attr('y', -15);\n  vis.bottomText.attr('x', vis.width/2)\n    .attr('y', 25);\n  /*** UPDATE SCALE ***/\n  vis.x.range([0, vis.width]);\n  \n  /*** RESIZE DRAWING GROUPS ***/\n  vis.topSlider.attr('transform', 'translate(0,'+ Math.floor(vis.height / 4) +')');\n  vis.bottomSlider.attr('transform', 'translate(0,'+ vis.height / 4 * 3 +')');\n  \n  vis.topAxisLine\n    .attr('x0', 0)\n    .attr('x1', vis.width);\n  vis.bottomAxisLine\n    .attr('x0', 0)\n    .attr('x1', vis.width);\n  \n  vis.yearsText\n    .attr('transform', 'translate(0,'+ vis.height/2 +')');     \n    \n  vis.yearsText.selectAll('text')\n    .attr('y', function(d) { return -vis.x(d) + 4; });\n  \n  vis.questionButton.attr('x', vis.width)\n    .attr('y', vis.height + 5);\n  \n  // update visualization now that size is set\n  vis.update();\n  \n  // return vis for chaining\n  return vis;\n}\n\nYearSlider.prototype.update = function() {\n  var vis = this;\n  \n  vis.updateMarkers();\n  vis.updateText();\n}\n\nYearSlider.prototype.updateText = function() {\n  var vis = this;\n  \n  var maxYear = d3.max([vis.topYear, vis.bottomYear]);\n  var minYear = d3.min([vis.topYear, vis.bottomYear]);\n  \n  vis.yearsText.selectAll('text')\n    .attr('font-weight', function(d) {\n      return (d >= minYear && d <= maxYear) ? 'bold' : 'lighter';\n    });\n}\n\nYearSlider.prototype.updateMarkers = function() {\n  var vis = this;\n  \n  var topMarker = vis.topSlider.selectAll('circle').data([vis.topYear]);\n  // enter\n  topMarker.enter()\n    .append('circle')\n      .attr('r', vis.marker.radius)\n      .on('mouseover', function() {vis.changeMarkerColor(topMarker, vis.colors.markers.top.hover);})\n      .on('mouseout', function() {vis.changeMarkerColor(topMarker, vis.colors.markers.top.normal);})\n      .call(vis.dragTopMarker);\n  // update  \n  topMarker.transition().duration(250)\n    .attr('cx', vis.x);\n    \n  var bottomMarker = vis.bottomSlider.selectAll('circle').data([vis.bottomYear]);\n  // enter\n  bottomMarker.enter()\n    .append('circle')\n      .attr('r', vis.marker.radius)\n      .on('mouseover', function() {vis.changeMarkerColor(bottomMarker, vis.colors.markers.bottom.hover);})\n      .on('mouseout', function() {vis.changeMarkerColor(bottomMarker, vis.colors.markers.bottom.normal);})\n      .call(vis.dragBottomMarker);\n  // update\n  bottomMarker.transition().duration(250)\n    .attr('cx', vis.x);\n}\n\nYearSlider.prototype.changeMarkerColor = function(marker, color) {\n  marker.attr('fill', color);\n}\n\nYearSlider.prototype.handleResize = function(event) {\n  this.resize();\n}\n\n/***--------------------------***\n *** MARKER DRAGGING BEHAVIOR ***\n ***--------------------------***/\n \nYearSlider.prototype.topMarkerStartedDragging = function(d) {\n  this.draggingSlider = 'topSlider';\n  this.draggingYear = 'topYear';\n  this.markerStartedDragging(d);\n}\n\nYearSlider.prototype.bottomMarkerStartedDragging = function(d) {\n  this.draggingSlider = 'bottomSlider';\n  this.draggingYear = 'bottomYear';\n  this.markerStartedDragging(d);\n}\n\nYearSlider.prototype.markerStartedDragging = function(d) {\n  this[this.draggingSlider].selectAll('circle').classed('dragging', true);\n}\n\nYearSlider.prototype.markerDragged = function(d) {\n  var vis = this;\n  // redraw objects as drag moves\n  // dragging should not extend objects outside of the slider's svg\n  var x = d3.min([d3.max([d3.event.x, 0]), vis.width]);\n  vis[vis.draggingSlider].select('circle').attr('cx', x);\n  vis[vis.draggingYear] = Math.round(vis.x.invert(x));\n  vis.updateText();\n}\n\nYearSlider.prototype.markerEndedDragging = function(d) {\n  // set new year values and call update to animate transition into stopping point\n  // broadcast new year values\n  this[this.draggingSlider].selectAll('circle').classed('dragging', false);\n  this.updateMarkers();\n  this.eventHandler().broadcast({\n    name:'update', \n    options:{\n      years: [parseYear(this.topYear.toString()), parseYear(this.bottomYear.toString())]\n    }\n  });\n}\n\nYearSlider.prototype.questionClicked = function() {\n  this.eventHandler().broadcast({\n    name:'question-clicked',\n    options: {}\n  });\n}\n\n\n\n\n\n\n\n\n\n\n\n\n"],"sourceRoot":"/source/"}