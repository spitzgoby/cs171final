{"version":3,"sources":["main.min.js"],"names":["loadData","error","topo","deaths","income","unemployment","drugUse","treatment","console","log","objects","usa","geometries","sort","a","b","id","forEach","state","years","year","death_rate","population","parseYear","median_income","d3","keys","k","date","dataLoaded","createVis","choropleth","Choropleth","eventHandler","handler","initVis","scatterplot","Scatterplot","yearSlider","YearSlider","on","this","displaySliderDescription","stackedAreaChart","StackedAreaChart","treemap","Treemap","singleYearSlider","SingleYearSlider","drugTypes","children","map","d","name","reverse","drugTypeLegend","DrugTypeLegend","updateFactor","factor","options","duration","broadcast","$","modal","parentElem","data","displayData","sizeGroup","types","EventHandler","listeners","Regression","xSeries","_xSeries","ySeries","_ySeries","reduceSum","prev","cur","coefficients","self","xBar","reduce","length","yBar","ssXX","Math","pow","ssYY","ssXY","i","slope","intercept","rSquare","format","formatIdentity","domain","min","max","shortName","formatCurrency","formatPercent","factorYear","deathRateYear","regression","chartElem","visible","treeData","year_index","zoomed","range","topYear","bottomYear","colors","markers","top","hover","normal","bottom","formatYear","time","parse","str","colorbrewer","Purples","unshift","stateColors","scale","quantile","drugColors","category20","dataDir","d3_queue","queue","defer","json","tsv","await","select","prototype","_eventHandler","handleUpdate","handleResize","drawHighlight","removeHighlight","vis","margin","right","left","keyHeight","keyRectHeight","svg","append","classed","graph","key","keyTitle","text","attr","projection","geo","albersUsa","path","resize","width","parseInt","style","height","keyWidth","floor","translate","update","keyLabelOffset","fontSize","wrangleData","getTime","html","keyRects","selectAll","enter","transition","keyLabels","states","topojson","feature","features","highlightState","unhighlightState","event","filter","legend","elementWidth","elements","elementsEnter","replace","eventName","listener","callback","push","bind","sender","padding","x","y","title","scatter","bfl","linear","xAxisG","yAxisG","xAxis","axis","ticks","orient","yAxis","xTitle","yTitle","stateTip","tip","direction","offset","call","bflTip","correlation","toFixed","labelFontSize","yAxisTicks","current","factorData","deathYearData","factorYearData","tickFormat","dots","coeff","bflData","x1","y1","x2","y2","sqrt","regLine","highlightBFL","unhighlightBFL","show","stateIndex","hide","switchView","clamp","brush","brushed","background","tickSize","tickPadding","parentNode","appendChild","cloneNode","slider","handle","extent","horizontalOffset","value","round","sourceEvent","invert","empty","area","y0","stack","layout","values","makeSubstanceTable","Object","substance","substances","substancesEnter","highlightSubstance","unhighlightSubstance","table","getFullYear","sticky","size","JSON","stringify","nodes","node","root","cells","cellsEnter","zoom","parent","dx","dy","w","getComputedTextLength","kx","ky","t","altKey","type","stopPropagation","question","descriptiveText","marker","radius","tick","dualSlider","topSlider","bottomSlider","yearsText","topAxis","bottomAxis","topAxisLine","bottomAxisLine","topText","bottomText","questionButton","questionClicked","dragDualSlider","behavior","drag","dualSliderStartedDragging","dualSliderDragged","dualSliderEndedDragging","dragTopMarker","topMarkerStartedDragging","markerDragged","markerEndedDragging","dragBottomMarker","bottomMarkerStartedDragging","updateMarkers","updateText","maxYear","minYear","draggingBoxData","draggingBox","topMarker","changeMarkerColor","bottomMarker","color","draggingSlider","draggingYear","markerStartedDragging","xs","x0","toString","prevX","topYearMarker","bottomYearMarker","newTopYearX","updateCircleX","newBottomYearX","abs","cx"],"mappings":"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","file":"main.min.js","sourcesContent":["  \n// convert year strings to date objects\nvar formatYear = d3.time.format('%Y');\nvar parseYear = formatYear.parse;\nvar formatPercent = d3.format('%');\nvar formatCurrency = d3.format('$');\nvar formatIdentity = function(str) { return str; };\n\n// universal color scales\ncolorbrewer.Purples[6].unshift('#ffffff'); // unshift places white as the first color\nvar stateColors = d3.scale.quantile()\n  .range(colorbrewer.Purples[6]);\nvar drugColors = d3.scale.category20();\n    \n/***---------------------***\n *** LOAD AND PARSE DATA ***\n ***---------------------***/\n  \n// load all data before cleaning\nvar dataLoaded = false;\nvar dataDir = 'data/';\nd3_queue.queue()\n  .defer(d3.json, dataDir+'topo_usa.json')\n  .defer(d3.json, dataDir+'state_deaths.json')\n  .defer(d3.json, dataDir+'state_income.json')\n  .defer(d3.json, dataDir+'state_unemployment.json')\n  .defer(d3.json, dataDir+'drug_use.json')\n  .defer(d3.tsv, dataDir+'treatment2003_2013.tsv')\n  .await(loadData);\n  \n// globals for data\nfunction loadData(error, topo, deaths, income, unemployment, drugUse, treatment) {\n  if (error) {\n    console.log(error);\n  } else {\n    topo.objects.usa.geometries.sort(function(a,b) {\n      if (a.id < b.id) return -1;\n      if (a.id > b.id) return 1;\n      return 0;\n    });\n    \n    // convert death data from strings to numbers and dates\n    deaths.forEach(function(state) {\n      state.years.forEach(function(year) {\n        year.death_rate = +year.death_rate;\n        year.deaths = +year.deaths;\n        year.population = +year.population;\n        year.year = parseYear(year.year);\n      });\n    });\n    // convert income data from strings to numbers and dates\n    income.forEach(function(state) {\n      state.years.forEach(function(year) {\n        year.median_income = +year.median_income / 1000,\n        year.year = parseYear(year.year)\n      });\n    });\n    \n    unemployment.forEach(function(state) {\n      state.years.forEach(function(year) {\n        year.unemployment = +year.unemployment;\n        year.year = parseYear(year.year);\n      })\n    });\n    \n    \n    treatment.forEach(function(year) {\n      var total = 0;\n      d3.keys(year).forEach(function(k) {\n        if (k === 'date') { year.date = parseYear(year.date); } \n        else { year[k] = +year[k]; }\n      });\n    });\n    \n    // update data loading status\n    dataLoaded = true;\n    // create visualizations\n    createVis(topo, deaths, income, unemployment, drugUse, treatment);\n  }\n}\n\n/***--------------------------------***\n *** DRAW AND UPDATE VISUALIZATIONS ***\n ***--------------------------------***/\n\nvar handler = new EventHandler();\n// couldn't fix bugs with treemap sticky layout, so resizing messages are suppressed\n// d3.select(window).on('resize', function() {handler.broadcast({name: 'resize'});});\nd3.select('#switch-view-button').on('click', function() {\n  handler.broadcast({name: 'switchView'});\n});\n\n// creates and initializes all visualizations \nfunction createVis(topo, deaths, income, unemployment, drugUse, treatment) {\n  \n  choropleth = new Choropleth('choropleth', topo, deaths);\n  choropleth.eventHandler(handler).initVis();\n  \n  scatterplot = new Scatterplot('scatterplot', 'median_income', deaths, income, unemployment);\n  scatterplot.eventHandler(handler).initVis();\n  \n  yearSlider = new YearSlider('year-slider', [2002, 2014]);\n  yearSlider.eventHandler(handler).initVis();\n  handler.on('question-clicked', this, displaySliderDescription);\n  \n  stackedAreaChart = new StackedAreaChart('dual-view-area', 'shared-chart', treatment);\n  stackedAreaChart.eventHandler(handler).initVis();\n  \n  treemap = new Treemap('dual-view-area', 'shared-chart', drugUse);\n  treemap.eventHandler(handler).initVis();\n  \n  singleYearSlider = new SingleYearSlider('single-year-slider', [2003, 2013]);\n  singleYearSlider.eventHandler(handler).initVis();\n  \n  drugTypes = drugUse.children.map(function(d) { return d.name; }).reverse();\n  drugTypeLegend = new DrugTypeLegend('drug-type-legend', drugTypes);\n  drugTypeLegend.eventHandler(handler).initVis();\n}\n\n// update visualizations based on selected options\nfunction updateFactor(factor) {\n  if (dataLoaded) {\n    // build options\n    options = {\n      factor: factor,\n      duration: 1000\n    };\n    \n    handler.broadcast({ name: 'update', options: options});\n  }\n}\n\nfunction displaySliderDescription() {\n  $('#slider-modal').modal();\n}\n/*--------------------*\n *** INITIALIZATION ***\n *--------------------*/\n\n/**\n * Creates a new choropleth\n *\n * @param parentElem  The dom element within which the visualization should be\n *                    appended\n * @param topo        The topojson data for the choropleth's map\n * @param data        The death data with which to color the map\n * @return Choropleth\n */\nfunction Choropleth(parentElem, topo, data) {\n  this.parentElem = parentElem;\n  this.topo = topo;\n  this.data = data;\n  this.displayData = {};\n  \n  this.sizeGroup = \"medium\";\n  this.default = {\n    duration: 1000\n  };\n}\n\n/**\n * If an event handler is specified sets the choropleth's handler and adds \n * the choropleth's listener callbacks. Returns the choropleth\n * If no event handler is specified returns the choropleth's current handler.\n *\n * @param handler The event handler to use with the choropleth\n * @return Choropleth|EventHandler\n */\nChoropleth.prototype.eventHandler = function(handler) {\n  if (handler) {\n    this._eventHandler = handler;\n    this._eventHandler.on('update', this, this.handleUpdate);\n    this._eventHandler.on('resize', this, this.handleResize);\n    this._eventHandler.on('mouseoverState', this, this.drawHighlight);\n    this._eventHandler.on('mouseoutState', this, this.removeHighlight);\n    return this;\n  }\n  \n  return this._eventHandler;\n}\n\n/**\n * Creates SVG and initializes visualization variables.\n *\n * @return Choropleth\n */\nChoropleth.prototype.initVis = function() {\n  var vis = this;\n  \n  /* DRAWING PARAMETERS */\n  vis.margin = { top: 40, right: 20, bottom: 20, left: 20 };\n  vis.keyHeight = 80;\n  vis.keyRectHeight = 20;\n  \n  /* ** CREATE DRAWING AREA ** */\n  vis.svg = d3.select('#'+vis.parentElem).append('svg')\n    .classed('us-map', true);\n  vis.graph = vis.svg.append('g');\n  vis.key = vis.svg.append('g').classed('key', true);\n  vis.keyTitle = vis.key.append('text')\n    .text('Deaths Per 100,000')\n    .classed('key-title', true)\n    .attr('text-anchor', 'middle');\n      \n  /*** MAP DRAWING FUNCTIONS ***/\n  vis.projection = d3.geo.albersUsa();\n  vis.path = d3.geo.path()\n    .projection(vis.projection);\n  \n  vis.resize();\n  // return vis for chaining\n  return vis;\n}\n\n\n/*------------*\n *** SIZING ***\n *------------*/\n\n/**\n * Resizes the visualization and redraws it within its parent element.\n *\n * @return Choropleth\n */\nChoropleth.prototype.resize = function() {\n  var vis = this;\n  \n  /* set width and height based on container */\n  vis.width = parseInt(d3.select('#'+vis.parentElem).style('width')) - vis.margin.left - vis.margin.right;\n  vis.height = vis.width * .8 - vis.margin.top - vis.margin.bottom;\n  vis.sizeGroup = (vis.width > 468) ? 'medium' : 'small';\n  \n  /* update margin transformations */\n  vis.svg.attr('width', vis.width + vis.margin.left + vis.margin.right)\n    .attr('height', vis.height + vis.margin.top + vis.margin.bottom + vis.keyHeight);\n    \n  vis.key.attr('transform', 'translate(0,10)');\n  vis.keyTitle.attr('x', vis.width/2)\n    .attr('y', 10);\n      \n  vis.graph.attr('transform', 'translate('+ vis.margin.left +','+ vis.margin.top +')');\n  \n  /* Rescale drawing parameters */\n  vis.keyWidth = Math.floor((1/6)*vis.width);\n  vis.projection.scale(vis.width * 1.35)\n    .translate([vis.width/2, vis.height/2]);\n    \n  vis.update({ duration: 0 });\n  \n  return vis;\n}\n\n/**\n * Returns the correct offset based on the visualization's current size group\n *\n * @return Number\n */\nChoropleth.prototype.keyLabelOffset = function() {\n  if (this.sizeGroup == 'medium') {\n    return 55;\n  } else {\n    return 50;\n  }\n}\n\n/**\n * Returns the correct font size based on the visualizations current size group\n *\n * @return String\n */\nChoropleth.prototype.fontSize = function() {\n  if (this.sizeGroup == \"medium\") {\n    return '14px';\n  } else {\n    return '12px';\n  }\n}\n\n/*---------------------------*\n *** DRAWING VISUALIZATION ***\n *---------------------------*/\n \n/**\n * Coerces data into an array the state's ID and death rate.\n * Accepted Options:\n *  years: Array of date objects, first date should be the year for death rate \n *\n * @param options The options for wrangling data\n */\nChoropleth.prototype.wrangleData = function(options) {\n  var vis = this;\n  if (!options || !options.years) {\n    vis.deathRateYear = parseYear('2014');\n  } else {\n    vis.deathRateYear = options.years[0];\n  }\n  \n  // empty object to hold filtered data\n  vis.displayData = vis.data.map(function(state) {\n    // filter out years falling beyond given date range\n    return {\n      id: state.id,\n      death_rate: state.years.reduce(function(prev, year) {\n        return prev + (year.year.getTime() == vis.deathRateYear.getTime() ? year.death_rate : 0);\n      }, 0)\n    };\n  });\n}\n\n\n/**\n * Updates the visualization according to the new data year\n * Accepted Options:\n *  years:    An array of year objects where the first year corresponds with \n *            death rate data\n *  duration: The duration (in milliseconds) that transitions should last\n *\n * @param options Options for redrawing the visualization \n * @return Choropleth\n */\nChoropleth.prototype.update = function(options) {\n  var vis = this;\n  vis.wrangleData(options);\n  \n  var duration = options.duration ? options.duration : vis.default.duration;\n  // change colors domain\n  stateColors.domain([0, 1, 5, 10, 15, 20]);\n  \n  vis.keyTitle.html('Deaths Per 100,000 <tspan class=\"death-rate-year\">('+ \n    formatYear(vis.deathRateYear) +')</tspan>');\n  \n  var keyRects = vis.key.selectAll('rect').data(stateColors.domain());\n  keyRects.enter().append('rect')\n    .classed('key-rect', true);\n  keyRects.transition().duration(duration)\n    .attr('x', function(d, i) { return i * vis.keyWidth; })\n    .attr('y', vis.keyRectHeight)\n    .attr('width', vis.keyWidth)\n    .attr('height', vis.keyRectHeight)\n    .attr('fill', function(d) { return stateColors(d); });\n  \n  var keyLabels = vis.key.selectAll('.key-label').data(stateColors.domain())\n  keyLabels.enter().append('text')\n    .classed('key-label', true);\n  keyLabels.transition().duration(duration)\n    .text(function(d, i) { \n      if (i == stateColors.domain().length - 1) return d +'+';\n      return d; \n    })\n    .attr('x', function(d,i) { return i * vis.keyWidth + 2;})\n    .attr('y', vis.keyLabelOffset())\n    .attr('font-size', vis.fontSize());\n    \n  \n  vis.states = vis.graph.selectAll('path')\n    .data(topojson.feature(vis.topo, vis.topo.objects.usa).features);\n  vis.states.enter()\n    .append('path')\n      .classed('state', true)\n      .on('mouseover', function(d) { vis.highlightState(d); })\n      .on('mouseout', function(d) { vis.unhighlightState(d); });\n  vis.states.transition().duration(duration)\n    .attr('d', vis.path)\n    .attr('fill', function(d, i) { \n      return stateColors(vis.displayData[i].death_rate); });\n  \n  return vis;\n}\n\n\n/*--------------------*\n *** EVENT HANDLERS ***\n *--------------------*/\n\n/**\n * Responds to resize events by calling the visualization's resize method\n */\nChoropleth.prototype.handleResize = function(event) {\n  this.resize();\n}\n\n/**\n * Handles update events by calling the visualizations update method\n */\nChoropleth.prototype.handleUpdate = function(event) {\n  this.update(event.options);\n}\n\n/**\n * Draws a highlight around the given state and broadcasts the highlight event\n *\n * @param d The state topojson path that triggered the highlight event\n */\nChoropleth.prototype.highlightState = function(d) {\n  this.drawHighlight(d).eventHandler().broadcast({ name: 'mouseoverState', id: d.id }, this);\n}\n\n/**\n * Removes the highlight from the given state and broadcasts the unhighlight \n * event\n *\n * @param d The state topojson path that triggered the unhighlight event\n */\nChoropleth.prototype.unhighlightState = function(d) {\n  this.removeHighlight(d).eventHandler().broadcast({ name: 'mouseoutState', id: d.id }, this);\n}\n\n/**\n * Draws a red ring around the highlighted state\n *\n * @param d The path of the state being highlighted\n * @return Choropleth\n */\nChoropleth.prototype.drawHighlight = function(d) {\n  var vis = this;\n  vis.states.filter(function(state) { return state.id == d.id})\n    .classed('highlighted', true);\n  return vis;\n}\n\n/**\n * Removes the red ring from the unhighlighted state\n *\n * @param d The path of the state having its highlight removed\n * @return Choropleth\n */\nChoropleth.prototype.removeHighlight = function(d) {\n  var vis = this;\n  this.states.filter(function(state) { return state.id == d.id; })\n    .classed('highlighted', false);\n  return vis;\n}\n\n\n\n/*--------------------*\n *** INITIALIZATION ***\n *--------------------*/\n \n/**\n * Creates a new DrugTypeLegend\n *\n * @param parentElem  The DOM element within which the legend should be drawn\n * @param types       The drug types displayed in the legend\n * @return DrugTypeLegend\n */\nfunction DrugTypeLegend(parentElem, types) {\n  this.parentElem = parentElem;\n  this.types = types;\n}\n\n/**\n * If a handler is specified the legend updates its event handler and registers \n * listeners for the events for which it's interested. The receiving object is \n * returned.\n * If no handler is given returns the object's current handler.\n *\n * @param handler (OptionaL)  The event handler for the object\n * @return DrugTypeLegend|EventHandler\n */\nDrugTypeLegend.prototype.eventHandler = function(eventHandler) {\n  if (eventHandler) {\n    this._eventHandler = eventHandler;\n    \n    return this;\n  }\n  \n  return this._eventHandler;\n}\n\n/**\n * Initializes the drug legend's svg and groups\n *\n * @return DrugTypeLegend\n */\nDrugTypeLegend.prototype.initVis = function() {\n  var vis = this;\n    \n  vis.svg = d3.select('#'+vis.parentElem).append('svg');\n  vis.legend = vis.svg.append('g').classed('legend', true);\n  \n  vis.resize();\n  \n  return vis;\n}\n\n\n/*--------------*\n *** RESIZING ***\n *--------------*/\n \n\n/**\n * Resizes the visualization according to the width of its parent element\n *\n * @return DrugTypeLegend\n */\nDrugTypeLegend.prototype.resize = function() {\n  var vis = this;\n  vis.margin = {top: 10, right: 100, bottom: 10, left: 100};\n  vis.width = parseInt(d3.select('#'+vis.parentElem).style('width')) - vis.margin.left - vis.margin.right,\n  vis.height = 50 - vis.margin.top - vis.margin.bottom;\n  \n  vis.svg\n    .attr(\"width\", vis.width + vis.margin.left + vis.margin.right)\n    .attr(\"height\", vis.height + vis.margin.top + vis.margin.bottom);\n  \n  vis.legend.attr(\"transform\", \"translate(\" + vis.margin.left + \",\" + vis.margin.top + \")\");\n  \n  vis.update();\n  \n  return vis;\n}\n\n\n/*---------------------------*\n *** DRAWING VISUALIZATION ***\n *---------------------------*/\n\n/**\n * Updates the visualization\n *\n * @return DrugTypeLegend\n */\nDrugTypeLegend.prototype.update = function() {\n  var vis = this;\n  \n  // get width of each legend element\n  var elementWidth = vis.width/vis.types.length;\n  var elements = vis.legend.selectAll(\"g\").data(vis.types);\n  \n  // enter\n  var elementsEnter = elements.enter().append(\"g\")\n    .attr(\"class\", \"legend\")\n    .attr('width', elementWidth);\n    \n  elementsEnter.append('rect');\n  elementsEnter.append('text')\n    .attr(\"dy\", \".35em\")\n    .attr(\"text-anchor\", \"middle\");\n  \n  // update\n  elements\n    .attr('transform', function(d,i) {\n      return 'translate('+ (i * elementWidth) +',0)';\n    });\n    \n  elements.selectAll('rect')\n    .attr(\"width\", 10)\n    .attr(\"height\", 10)\n    .attr('x', (elementWidth/2) - 5)\n    .style(\"fill\", function(d) { return drugColors(d); });\n\n  elements.selectAll('text')\n    .text(function(d) { return d.replace('_', ' '); })\n    .attr(\"x\", elementWidth/2)\n    .attr(\"y\", 30);\n  \n  return vis;\n}\n\n\n/*--------------*\n *** RESIZING ***\n *--------------*/\n\n/**\n * Responds to resize events\n *\n * @return DrugTypeLegend\n */\nDrugTypeLegend.prototype.handleResize = function(event) {\n  this.resize();\n}\n\n/**\n * Creates a new EventHanlder object\n *\n * @return EventHandler\n */\nfunction EventHandler() {\n  this.listeners = {};\n}\n\n/**\n * Adds an event listener for events with the given name. Note that\n * this method does not check for uniqueness. If a listener registers\n * for an event multiple times it will receive multiple notifications\n * when the event occurs.\n *\n * @param eventName   The name of the event being listened for\n * @param listener    The object interested in listening for the event\n * @param callback    The callback for handling the event, which is passed\n *                    to the callback as the only parameter\n *\n * @return EventHandler\n */\nEventHandler.prototype.on = function(eventName, listener, callback) {\n  var listeners = this.listeners[eventName];\n  if (!listeners) {\n    listeners = [];\n  }\n  listeners.push({listener: listener, callback: callback.bind(listener)});\n  this.listeners[eventName] = listeners;\n  \n  return this;\n}\n\n/**\n * Informs all interested listeners of the occurrence of a given event. \n * If the caller provides a value for sender, the sender will not be \n * informed of the event.\n *\n * @param event   An object containing important event properties. \n *                'name' is the only required property.\n * @param sender  (Optional) The object that broadcast the event. If \n *                specified then the sender will not have any of its\n *                callbacks fired.\n *\n * @return EventHandler\n */\nEventHandler.prototype.broadcast = function(event, sender) {\n  var listeners = this.listeners[event.name];\n  if (listeners) {\n    listeners.forEach(function(listener) {\n      if (listener.listener != sender) {\n        listener.callback(event);\n      }\n    });\n  }\n  return this;\n}\n\n// code found at http://bl.ocks.org/benvandyke/8459843\nfunction Regression() {\n  this.xSeries = function(xSeries) {\n    if (!xSeries) {\n      return this._xSeries;\n    }\n    \n    this._xSeries = xSeries;\n    return this;\n  };\n  \n  this.ySeries = function(ySeries) {\n    if (!ySeries) {\n      return this._ySeries;\n    }\n    \n    this._ySeries = ySeries;\n    return this;\n  };\n  \n  this.reduceSum = function(prev, cur) {\n    return prev + cur;\n  };\n  \n  this.coefficients = function() {\n    var self = this;\n    var xBar = this._xSeries.reduce(this.reduceSum) * 1.0 / this._xSeries.length;\n    var yBar = this._ySeries.reduce(this.reduceSum) * 1.0 / this._ySeries.length;\n\n    var ssXX = this._xSeries.map(function(d) { return Math.pow(d - xBar, 2); })\n      .reduce(this.reduceSum);\n    \n    var ssYY = this._ySeries.map(function(d) { return Math.pow(d - yBar, 2); })\n      .reduce(this.reduceSum);\n      \n    var ssXY = this._xSeries.map(function(d, i) { return (d - xBar) * (self._ySeries[i] - yBar); })\n      .reduce(this.reduceSum);\n      \n    var slope = ssXY / ssXX;\n    var intercept = yBar - (xBar * slope);\n    var rSquare = Math.pow(ssXY, 2) / (ssXX * ssYY);\n    \n    return [slope, intercept, rSquare];\n  };\n}\n\n/*--------------------*\n *** INITIALIZATION ***\n *--------------------*/\n\n/**\n * Creates a new Scatterplot visualization\n *\n * @param parentElem    The ID of the DOM element within which the visualization\n *                      should be drawn.\n * @param deaths        An array of death data sorted alphabetically by state\n * @param income        An array of income data sorted alphabetically by state\n * @param unemployment  An array of unemployment data sorted alphabetically by \n *                      state\n * @return Scatterplot\n */\nfunction Scatterplot(parentElem, factor, deaths, income, unemployment) {\n  this.parentElem = parentElem;\n  this.data = {\n    'death_rate': {\n      data: deaths,\n      name: 'Deaths Per 100,000',\n      format: formatIdentity,\n      domain: [\n        d3.min(deaths, function(d) { return d3.min(d.years, function(d) {return d.death_rate; }); }),\n        d3.max(deaths, function(d) { return d3.max(d.years, function(d) {return d.death_rate; }); })\n      ]\n    },\n    'median_income': {\n      data: income,\n      name: 'Median Income (1000s)',\n      shortName: 'Median Income',\n      format: formatCurrency,\n      domain: [\n        d3.min(income, function(d) { return d3.min(d.years, function(d) {return d.median_income; }); }),\n        d3.max(income, function(d) { return d3.max(d.years, function(d) {return d.median_income; }); })\n      ]\n    },\n    'unemployment': {\n      data: unemployment,\n      name: 'Unemployment Rate',\n      shortName: 'Unemployment Rate',\n      format: formatPercent,\n      domain: [\n        d3.min(unemployment, function(d) { return d3.min(d.years, function(d) {return d.unemployment; }); }),\n        d3.max(unemployment, function(d) { return d3.max(d.years, function(d) {return d.unemployment; }); })\n      ]\n    }\n  };\n  \n  this.factor = factor;\n  this.factorYear = parseYear('2014');\n  this.deathRateYear = parseYear('2014');\n  \n  this.displayData = {};\n  this.regression = new Regression();\n  \n  this.sizeGroup = \"medium\";\n  this.default = {\n    duration: 1000\n  }\n}\n\n/**\n * If a handler is specified the Scatterplot updates its event handler and \n * registers listeners for the events for which it's interested. The receiving\n * object is returned.\n * If no handler is given returns the objects current handler.\n *\n * @param handler (Optional) The event handler for the object\n * @return EventHandler|Scatterplot\n */\nScatterplot.prototype.eventHandler = function(handler) {\n  if (handler) {\n    this._eventHandler = handler;\n    this._eventHandler.on('update', this, this.handleUpdate);\n    this._eventHandler.on('resize', this, this.handleResize);\n    this._eventHandler.on('mouseoverState', this, this.drawHighlight);\n    this._eventHandler.on('mouseoutState', this, this.removeHighlight);\n  \n    return this;\n  }\n  return this._eventHandler;\n}\n\n/**\n * Initalizes the visualization by appending and sizing the containing SVG \n * before defining scales and axes. Should only be called once on a given \n * scatter plot.\n *\n * @return Scatterplot\n */\nScatterplot.prototype.initVis = function() {\n  // grab reference to self\n  var vis = this;\n  \n  /*** SVG DRAWING AREA ***/\n  vis.margin = {top: 20, right: 20, bottom: 40, left: 50};\n  vis.padding = {x: 10, y: 10};\n      \n  vis.svg = d3.select('#'+vis.parentElem).append('svg');\n  vis.graph = vis.svg.append('g');\n  \n  vis.title = vis.graph.append('text')\n    .text('What Factors Influence Drug Deaths?')\n    .attr('text-anchor', 'middle')\n    .attr('font-weight', 'bold');\n      \n  /*** CHART DATA ELEMENTS ***/\n  vis.scatter = vis.graph.append('g')\n    .classed('scatter-plot', true);\n    \n  vis.bfl = vis.graph.append('g')\n    .classed('best-fit', true);\n    \n  vis.x = d3.scale.linear();\n  vis.y = d3.scale.linear();\n    \n  /*** CHART AXES ***/\n  vis.xAxisG = vis.graph.append('g')\n    .classed('axis x-axis', true);\n    \n  vis.yAxisG = vis.graph.append('g')\n    .classed('axis y-axis', true);\n    \n  vis.xAxis = d3.svg.axis()\n    .scale(vis.x)\n    .ticks(6)\n    .orient('bottom');\n    \n  vis.yAxis = d3.svg.axis()\n    .scale(vis.y)\n    .orient('left');\n    \n  vis.xTitle = vis.xAxisG.append('text')\n    .classed('axis-label', true)\n    .attr('text-anchor', 'middle');\n    \n  vis.yTitle = vis.yAxisG.append('text')\n    .classed('axis-label', true)\n    .attr('transform', 'rotate(-90)')\n    .attr('text-anchor', 'middle')\n    .text('Deaths per 100,000');\n    \n  vis.stateTip = d3.tip()\n    .attr('class', 'd3-tip')\n    .direction('s')\n    .offset([5,0])\n    .html(function(d) {\n      return ''+\n        '<h4>'+ d.id +'</h4><p>'+\n          '<span class=\"tip-header\">Death Rate: <span class=\"death-rate\">'+ \n            d.death_rate +'</span></span><br>'+\n          '<span class=\"tip-header\">'+ vis.data[vis.factor].name +\n            ': <span class=\"factor\">'+ vis.data[vis.factor].format(d.factor) +'</span></span></p>';\n    });\n  vis.graph.call(vis.stateTip);\n  \n  vis.bflTip = d3.tip()\n    .attr('class', 'd3-tip')\n    .direction('s')\n    .offset([5,0])\n    .html(function(d) {\n      return ''+\n        '<span class=\"tip-header\">Death Rate <span class=\"tip-death-rate\">('\n          + formatYear(vis.deathRateYear) +')</span></span><br>'+\n        '<span class=\"tip-header\">'+ vis.data[vis.factor].shortName +\n          ' <span class=\"tip-factor\">('+ formatYear(vis.factorYear) +')</span></span><br>'+\n        '<span class=\"tip-header\">Correlation: '+ d.correlation.toFixed(2) +'</span>'+\n        '<span class=\"more-info\">Click for detailed information</span>';\n    });\n  vis.graph.call(vis.bflTip);\n  \n  vis.resize();\n  \n  // return vis for chaining\n  return vis;\n}\n\n/*------------*\n *** SIZING ***\n *------------*/\n\nScatterplot.prototype.labelFontSize = function() {\n  if (this.sizeGroup == 'medium') return '10pt'; \n  return '8pt';\n}\n\nScatterplot.prototype.yAxisTicks = function() {\n  if (this.sizeGroup == 'medium') return 10;\n  return 4;\n}\n\n/**\n * Resizes the visualization according to its parent within the DOM. \n *\n * @return Scatterplot\n */\nScatterplot.prototype.resize = function() {\n  var vis = this;\n  \n  // grab width of current container\n  vis.width = parseInt(d3.select('#'+vis.parentElem).style('width')) - vis.margin.left - vis.margin.right;\n  vis.height = vis.width;\n  \n  // update size group\n  vis.sizeGroup = (vis.width > 256) ? 'medium' : 'small';\n    \n  // resize svg, reset margin\n  vis.svg.attr('width', vis.width + vis.margin.left + vis.margin.right)\n    .attr('height', vis.height + vis.margin.top + vis.margin.bottom);\n  vis.graph.attr('transform', 'translate('+ vis.margin.left +','+ vis.margin.top +')');\n  \n  vis.title.attr('x', vis.width/2)\n    .attr('y', 6)\n    .attr('font-size', vis.labelFontSize());\n  // change scale drawing range\n  vis.x.range([vis.padding.x, vis.width-vis.padding.x]);\n  vis.y.range([vis.height-vis.padding.y, vis.padding.y]);\n  // update axis offests and title positions\n  vis.xAxisG.attr('transform', 'translate(0, '+ vis.height +')');\n  vis.xTitle.attr('x', vis.width/2)\n    .attr('y', vis.margin.bottom-2);\n    \n  vis.yAxis.ticks(vis.yAxisTicks());\n  vis.yTitle.attr('x', -vis.width/2)\n    .attr('y', -vis.margin.left * (3/4) );\n  \n  // update vis with default options now that svg has been resized\n  vis.update(vis.default);\n  \n  // return vis for chaining\n  return vis;\n}\n\n\n/*---------------------------*\n *** DRAWING VISUALIZATION ***\n *---------------------------*/\n\n/**\n * Filters the visualizations data by year according to the given options \n * Accepted Options:\n *  year: The year for which to show data on the x axis\n *\n * @param options (Optional) An object containing options for manipulating data \n * @return Scatterplot\n */\nScatterplot.prototype.wrangleData = function(options) {\n  var vis = this;\n  \n  if (!options) {\n    // create local shadow variable so shared object doesn't change\n    var options = {};\n  }\n  \n  vis.deathRateYear = options.years ? options.years[0] : vis.deathRateYear; \n  vis.factorYear = options.years ? options.years[1] : vis.factorYear;\n  vis.factor = options.factor ? options.factor : vis.factor;\n  \n  // wrangled data is placed into variable displayData\n  vis.displayData = vis.data[vis.factor].data.reduce(function(prev, current, i) {\n    // skip any national data\n    if (current.id === 'United States') {\n      return prev;\n    }\n    \n    // grab corresponding state death and factor data\n    var deaths = vis.data['death_rate'].data[i];\n    var factorData = vis.data[vis.factor].data[i];\n    \n    // get data only from specified year\n    deathYearData = deaths.years.filter(function(y) { \n      return y.year.getTime() == vis.deathRateYear.getTime(); })[0];\n    factorYearData = factorData.years.filter(function(y) {\n      return y.year.getTime() == vis.factorYear.getTime(); })[0];\n    \n    // add an object with the state's data to the array\n    prev.push({\n      id: current.id,\n      death_rate: deathYearData.death_rate,\n      factor: factorYearData[vis.factor]\n    });\n    return prev; \n  }, []);\n  \n  // return vis for chaining\n  return vis;\n}\n\n/**\n * Updates the visualization by updating display data according to the given\n * options and redrawing the scatterplot accordingly.\n * Accepted Options:\n *  year: The year to use when drawing the x axis (default is most recent)\n *  duration: The duration of any trasnitions (default is 0)\n *\n * @param options The options for updating the scatterplot.\n * @return Scatterplot\n */\nScatterplot.prototype.update = function(options) {\n  var vis = this;\n  \n  // update display data\n  vis.wrangleData(options);\n  \n  var duration = options.duration ? options.duration : vis.default.duration;\n  // update x and y domains according to new data\n  vis.x.domain(vis.data[vis.factor].domain);\n  vis.y.domain([0, 35]);\n  \n  // redraw axes\n  vis.xTitle\n    .html(vis.data[vis.factor].name +\n      ' <tspan class=\"factor\">('+ formatYear(vis.factorYear) +')</tspan>')\n    .attr('font-size', vis.labelFontSize());\n    \n  vis.yTitle\n    .html(vis.data.death_rate.name +\n      ' <tspan class=\"death_rate\">('+ formatYear(vis.deathRateYear) +')</tspan>')\n    .attr('font-size', vis.labelFontSize());\n  \n  vis.xAxis.tickFormat(vis.data[vis.factor].format);\n  vis.xAxisG.transition().duration(duration)\n    .call(vis.xAxis);\n  vis.yAxisG.transition().duration(duration)\n    .call(vis.yAxis);\n  // update scatter plot dots data\n  vis.dots = vis.scatter.selectAll('circle').data(vis.displayData);\n  // draw any new dots \n  vis.dots.enter()\n    .append('circle')\n      .attr('class', function(d) { return 'dot '+d.id.replace(' ', ''); })\n      .attr('r', 5)\n      .on('mouseover', vis.highlightState.bind(vis))\n      .on('mouseout', vis.unhighlightState.bind(vis));\n  // move existing dots into new position according to display data  \n  vis.dots.transition().duration(duration)\n    .attr('cx', function(d) { return vis.x(d.factor); })\n    .attr('cy', function(d) { return vis.y(d.death_rate); })\n    .attr('fill', function(d) { return stateColors(d.death_rate)});\n      \n  // get variables to pass to regression calculator\n  var xSeries = vis.displayData.map(function(d) { return d.factor; });\n  var ySeries = vis.displayData.map(function(d) { return d.death_rate;});\n  var coeff = vis.regression.xSeries(xSeries)\n    .ySeries(ySeries)\n    .coefficients();\n  \n  // calculate best fit line path\n  var bflData = [{x1: vis.x.domain()[0], y1: coeff[1],\n                  x2: vis.x.domain()[1], y2: coeff[0] * vis.x.domain()[1] + coeff[1],\n                  correlation: Math.sqrt(coeff[2])}];\n  vis.regLine = vis.bfl.selectAll('line').data(bflData);\n  // append best fit line (if necessary) or redraw with new data\n  vis.regLine.enter().append('line')\n    .classed('best-fit', true)\n    .on('mouseover', function(d) { vis.highlightBFL(d); })\n    .on('mouseout', function(d) { vis.unhighlightBFL(d); });\n  vis.regLine.transition().duration(duration)\n    .attr('x1', function(d) { return vis.x(d.x1); })\n    .attr('y1', function(d) { return vis.y(d.y1); }) \n    .attr('x2', function(d) { return vis.x(d.x2); })\n    .attr('y2', function(d) { return vis.y(d.y2); });\n}\n\n/*--------------------*\n *** EVENT HANDLERS ***\n *--------------------*/\n\n/**\n * Handles 'resize' events by calling the visualizations resize method. \n *\n * @param event The event object\n */\nScatterplot.prototype.handleResize = function(event) {\n  this.resize();\n}\n \n/**\n * Handles 'update' events by calling the visualizations 'update' method\n *\n * @param event The event object created by the object that fired the event\n */\nScatterplot.prototype.handleUpdate = function(event) {\n  this.update(event.options);\n}\n\n\n/**\n * Draws a red ring around highlighted dot and increases its size\n *\n * @return Scatterplot\n */\nScatterplot.prototype.drawHighlight = function(d) {\n  var vis = this;\n  vis.dots.filter(function(state) { return state.id == d.id; })\n    .classed('highlighted', true)\n    .attr('r', 10);\n  vis.stateTip.show(vis.displayData[vis.stateIndex(d)]);\n  // return vis for chaining\n  return vis;\n}\n\n/**\n * Removes red ring around highlighted state and reduces its size back to the \n * starting amount.\n *\n * @return Scatterplot\n */\nScatterplot.prototype.removeHighlight = function(d) {\n  var vis = this;\n  vis.dots.filter(function(state) { return state.id == d.id; })\n    .classed('highlighted', false)\n    .attr('r', 5);\n  vis.stateTip.hide();\n  // return vis for chaining\n  return vis;\n}\n\nScatterplot.prototype.highlightBFL = function(d) {\n  this.regLine.classed('highlighted', true);\n  this.bflTip.show(d);  \n}\n\nScatterplot.prototype.unhighlightBFL = function(d) {\n  this.regLine.classed('highlighted', false);\n  this.bflTip.hide();\n}\n\n/**\n * Draws highlight around selected state and broadcasts event \n *\n * @param d The dot of the state being highlighted\n */\nScatterplot.prototype.highlightState = function(d) {\n  this.drawHighlight(d).eventHandler().broadcast({ name: 'mouseoverState', id: d.id }, this);\n}\n\n/**\n * Removes highlight from deselected state and broadcasts event\n *\n * @param d The dot of the state having its highlight removed\n */\nScatterplot.prototype.unhighlightState = function(d) {\n  this.removeHighlight(d).eventHandler().broadcast({ name: 'mouseoutState', id: d.id }, this);\n}\n\nScatterplot.prototype.stateIndex = function(d) {\n  for (var i = 0; i < this.displayData.length; i++) {\n    if (this.displayData[i].id == d.id) return i;\n  }\n  return 0;\n}\n\n/*--------------------*\n *** INITIALIZATION ***\n *--------------------*/\n\n/**\n * Creats a new SingleYearSlider\n *\n * @param parentElem  The DOM element within which the slider should be drawn\n * @param years       An array of years to show in the slider\n * @return SingleYearSlider\n */\nfunction SingleYearSlider(parentElem, years) {\n  this.parentElem = parentElem;\n  this.years = years;\n}\n\n/**\n * If a handler is specified the Treemap updates its event handler and registers \n * listeners for the events for which it's interested. The receiving object is \n * returned.\n * If no handler is given returns the object's current handler.\n *\n * @param handler (OptionaL)  The event handler for the object\n * @return Treemap|EventHandler\n */\nSingleYearSlider.prototype.eventHandler = function(eventHandler) {\n  if (eventHandler) {\n    this._eventHandler = eventHandler;\n    this._eventHandler.on('switchView', this, this.switchView);\n    \n    return this;\n  }\n  \n  return this._eventHandler;\n}\n\n/**\n * Initializes the visualization by appending the necessary svg groups and \n * defining scales and axes. Should only be called once on a given stacked area\n * chart.\n *\n * @return SingleYearSlider\n */\nSingleYearSlider.prototype.initVis = function() {\n  var vis = this;\n  \n  vis.svg = d3.select('#'+vis.parentElem).append(\"svg\");\n  vis.graph = vis.svg.append('g')\n    .attr(\"class\", \"slider\").attr('opacity', 1); // starts visible\n\n  vis.x = d3.scale.linear()\n    .domain(vis.years)\n    .clamp(true);\n\n  vis.brush = d3.svg.brush()\n    .x(vis.x)\n    .on(\"brush\", function() {vis.brushed();});\n\n  vis.background = vis.graph.append(\"rect\")\n      .attr(\"class\", \"slider_background\");\n      \n  vis.xAxis = d3.svg.axis()\n    .scale(vis.x)\n    .orient(\"bottom\")\n    .tickFormat(function (d) { return +d; })\n    .tickSize(0)\n    .tickPadding(12)\n    \n  vis.graph.append(\"g\")\n    .attr(\"class\", \"x axis\")\n    .select(function () { return this.parentNode.appendChild(this.cloneNode(true)); })\n    .attr(\"class\", \"halo\");\n\n  vis.slider = vis.graph.append(\"g\")\n    .attr(\"class\", \"slider\")\n    .call(vis.brush);\n\n  vis.handle = vis.slider.append(\"circle\")\n    .attr(\"class\", \"handle\")\n    .attr(\"r\", 9);\n    \n  vis.resize();\n  \n  return vis;\n}\n\n\n/*--------------*\n *** RESIZING ***\n *--------------*/\n\n/**\n * Resizes the visualization and redraws it within its parent element.\n *\n * @return SingleYearSlider\n */\nSingleYearSlider.prototype.resize = function() {\n  var vis = this;\n  \n  vis.margin = { top: 10, left: 100, right: 100, bottom: 0};\n  vis.width = parseInt(d3.select('#'+vis.parentElem).style('width')) - vis.margin.left - vis.margin.right,\n  vis.height = 50 - vis.margin.top - vis.margin.bottom;\n  vis.svg\n    .attr(\"width\", vis.width + vis.margin.right + vis.margin.left)\n    .attr(\"height\", vis.height + vis.margin.top + vis.margin.bottom)\n    \n  vis.x.range([0, vis.width]);\n  \n  vis.graph.attr(\"transform\", \"translate(\" + vis.margin.left + \",\" + vis.margin.top + \")\");\n  vis.graph.call(vis.xAxis);\n  \n  vis.background\n    .attr(\"height\", 4)\n    .attr(\"width\", vis.width);\n    \n  vis.slider.select(\".background\")\n    .attr(\"height\", 100);\n    \n  vis.update({ year:vis.years[vis.years.length-1] });\n  \n  return vis;\n}\n\n/**\n * Updates the visualization according to the new data year\n * Accepted Options: (currently none)\n *\n * @param options Options for redrawing the visualization \n * @return SingleYearSlider\n */\nSingleYearSlider.prototype.update = function(options) {\n  var vis = this;\n  \n  var year = options.year;\n  \n  vis.slider\n    .call(vis.brush.event)\n    .transition()\n    .duration(750)\n    .call(vis.brush.extent([2013, 2013]))\n    .call(vis.brush.event);\n}\n\n\n/*--------------------*\n *** EVENT HANDLERS ***\n *--------------------*/\n \n/**\n * Handles brush events by moving the slider handle and broadcasting the change \n * in years.\n *\n * @return SingleYearSlider\n */\nSingleYearSlider.prototype.brushed = function() {\n  var horizontalOffset = (parseInt(d3.select(\"body\").style('width')) - this.width) / 2;\n  var vis = this;\n  var value = Math.round(vis.brush.extent()[0]);\n  if (d3.event.sourceEvent) { // not a programmatic event\n    value = Math.round(vis.x.invert(d3.event.sourceEvent.x - horizontalOffset));\n    this.eventHandler().broadcast({ name:'updateDrugs', year:value}, vis);\n  }\n\n  vis.handle.attr(\"cx\", vis.x(value));\n  \n  return vis;\n}\n\nSingleYearSlider.prototype.switchView = function(event) {\n  var vis = this;\n  vis.graph.transition().duration(1000)\n    .attr('opacity', (+vis.graph.attr('opacity') == 1) ? 0 : 1);\n}\n\n/**\n * Handles resize events \n *\n * @return SingleYearSlider\n */\nSingleYearSlider.prototype.handleResize = function(event) {\n  var vis = this;\n  \n  vis.resize();\n  \n  return vis;\n}\n/*--------------------*\n *** INITIALIZATION ***\n *--------------------*/\n\n/**\n * Creates a new Stacked Area Chart visualization\n *\n * @param parentElem  The ID of the DOM element within which the visualization\n *                    should be drawn.\n * @param chartElem   The ID of the DOM SVG element within which the \n *                    visualization should be drawn. \n * @param data        An array of substance abuse data organized by year\n * @return StackedAreaChart\n */\nfunction StackedAreaChart(parentElem, chartElem, data) {\n  this.parentElem = parentElem;\n  this.chartElem = chartElem;\n  this.data = data;\n  this.visible = false;\n}\n\n/**\n * If a handler is specified the StackedAreaChart updates its event handler and\n * registers listeners for the events for which it's interested. The receiving\n * object is returned.\n * If no handler is given returns the object's current handler.\n *\n * @param handler (OptionaL)  The event handler for the object\n * @return StackedAreaChart|EventHandler\n */\nStackedAreaChart.prototype.eventHandler = function(eventHandler) {\n  if (eventHandler) {\n    this._eventHandler = eventHandler;\n    this._eventHandler.on('switchView', this, this.switchView);\n    \n    return this;\n  }\n  \n  return this._eventHandler;\n}\n\n/**\n * Initializes the visualization by appending the necessary svg groups and \n * defining scales and axes. Should only be called once on a given stacked area\n * chart.\n *\n * @return StackedAreaChart\n */\nStackedAreaChart.prototype.initVis = function() {\n  var vis = this;\n    \n  /*** SVG DRAWING AREA ***/\n  vis.svg = d3.select('#'+vis.parentElem).selectAll('svg#'+vis.chartElem);\n  if (vis.svg.empty()) {\n    vis.svg = d3.select('#'+vis.parentElem).append('svg');\n  }\n  vis.graph = vis.svg.append('g')\n    .classed('graph', true);\n  \n  /*** CHART DATA ELEMENTS ***/\n  vis.x = d3.time.scale();\n  vis.y = d3.scale.linear();\n  \n  vis.area = d3.svg.area()\n    .x(function(d) { return vis.x(d.date); })\n    .y0(function(d) { return vis.y(d.y0); })\n    .y1(function(d) { return vis.y(d.y0 + d.y); });\n  vis.stack = d3.layout.stack()\n    .values(function(d) { return d.values; });\n      \n  /*** CHART AXES ***/\n  vis.xAxis = d3.svg.axis()\n    .scale(vis.x)\n    .orient(\"bottom\");\n  vis.yAxis = d3.svg.axis()\n    .orient(\"left\")\n    .scale(vis.y)\n    .tickFormat(d3.format(\",.0f\"));\n    \n  vis.xAxisG = vis.graph.append(\"g\")\n    .attr(\"class\", \"x axis\");\n  vis.yAxisG = vis.graph.append(\"g\")\n    .attr(\"class\", \"y axis\")\n      \n  /*** CHART TIP ***/\n  vis.tip = d3.tip()\n    .attr('class', 'd3-tip')\n    .html(function(d) {\n      return \"\"+\n        \"<table>\"+ \n          \"<th>Substance Type: \"+ d.name +\"</th>\"+ \n          vis.makeSubstanceTable(d.values)+ \n        \"</table>\";\n    });\n  vis.graph.call(vis.tip);\n  \n  // resize graph on initialization\n  vis.resize();\n  \n  // Return vis for chaining\n  return vis;\n}\n\n\n/*------------*\n *** SIZING ***\n *------------*/\n \n/**\n * Resizes the visualization according to its parent's width within the DOM\n *\n * @return StackedAreaChart\n */\nStackedAreaChart.prototype.resize = function() {\n  var vis = this;\n  \n  /*** PARENT SIZE ***/\n  vis.margin = {top: 10, right: 100, bottom: 30, left: 100},\n  vis.width = parseInt(d3.select('#'+vis.parentElem).style('width')) - vis.margin.left - vis.margin.right,\n  vis.height = vis.width * .66 - vis.margin.top - vis.margin.bottom;\n  \n  /*** UPDATE GRAPH SIZES ***/\n  vis.svg\n    .attr('width', vis.width + vis.margin.left + vis.margin.right)\n    .attr('height', vis.height + vis.margin.top + vis.margin.bottom);\n  \n  vis.graph\n    .attr('transform', 'translate(3000,'+ vis.margin.top +')'); // starts offscreen\n  \n  /*** UPDATE SCALES AND AXES ***/\n  vis.x.range([0, vis.width]);\n  vis.y.range([vis.height, 0]);\n  \n  vis.xAxisG.attr(\"transform\", \"translate(0,\" + vis.height + \")\");\n  \n  // update the visualization with its new size \n  vis.update();\n  \n  // return vis for chaining\n  return vis;\n}\n\n\n/*---------------------------*\n *** DRAWING VISUALIZATION ***\n *---------------------------*/\n\n/**\n * Restructures the visualizations data into an array that works with d3's stack\n * layout and sets this array to the member variable \"displayData\"\n *\n * @param options (Optional)  An object containing options for manipulating data\n * @return StackedAreaChart\n */\nStackedAreaChart.prototype.wrangleData = function(options) {\n  var vis = this;\n  \n  vis.displayData = vis.stack(Object.keys(vis.data[0]).filter(function(k) { return k !== 'date';})\n    .map(function(substance) {\n      return {\n        name: substance,\n        values: vis.data.map(function(d) { return { date: d.date, y: d[substance]}; }) \n      };\n    }));\n  \n  return this;\n}\n\n/**\n * Updates the visualization by updating display data and redrawing the \n * stacked area chart accordingly.\n * Accepted Options: (currently none)\n *\n * @param options (Optional)  The options for updating the stacked area chart\n * @return StackedAreaChart\n */\nStackedAreaChart.prototype.update = function(options) {\n  var vis = this;\n  \n  vis.wrangleData(options);\n  \n  vis.x.domain(d3.extent(vis.data, function(d) { return d.date; }));\n  vis.y.domain([0, 2100000]);\n  \n  vis.stack(vis.displayData);\n  \n  var substances = vis.graph.selectAll(\".substance\").data(vis.displayData);\n  \n  var substancesEnter = substances.enter().append(\"g\")\n    .attr(\"class\", \"substance\");\n\n  substancesEnter.append(\"path\")\n    .attr(\"class\", \"area\");\n  substances.selectAll('path.area')\n    .attr(\"d\", function(d) { return vis.area(d.values); })\n    .attr(\"fill\", function(d) { return drugColors(d.name); })\n    .attr('stroke-width', 2)\n    .on('mouseover', function(d) { vis.highlightSubstance(d) })\n    .on('mouseout', function(d) { vis.unhighlightSubstance(d) });\n\n  vis.xAxisG.call(vis.xAxis);\n  vis.yAxisG.call(vis.yAxis);\n  \n  return vis;\n}\n\n/**\n * Displays a d3 tip for the given substance\n *\n * @param d The substance data element that was highlighted\n * @return StackedAreaChart\n */\nStackedAreaChart.prototype.highlightSubstance = function(d) {\n  var vis = this;\n  vis.tip.show(d);\n  return vis;\n}\n\n/**\n * Removes a d3 tip from the given substance\n *\n * @param d The substance data element that was unhighlighted \n * @return StackedAreaChart\n */\nStackedAreaChart.prototype.unhighlightSubstance = function(d) {\n  var vis = this;\n  vis.tip.hide(d);\n  \n  return vis;\n}\n\n/**\n * Generates a table with data from the given substance\n *\n * @return String\n */\nStackedAreaChart.prototype.makeSubstanceTable = function(data){\n  table = \"<tr><td>Year</td><td>Admissions to Treatment</td>\";\n  for(var i=0;i<data.length;i++){\n      table += \"<tr>\"+\n              \"<td>\" + data[i].date.getFullYear() + \"</td>\" +\n              \"<td>\" + (parseInt(data[i].y*2100000)) + \"</td>\" +\n          \"</tr>\";\n  }\n  return table;\n}\n\n/*--------------------*\n *** EVENT HANDLERS ***\n *--------------------*/\n\n/**\n * Handles a resize event from the visualization's event handler.\n */\nStackedAreaChart.prototype.handleResize = function(event) {\n  this.resize();\n}\n\n/**\n * Switch the visibility of the visualization\n *\n * @return StackedAreaChart\n */\nStackedAreaChart.prototype.switchView = function(event) {\n  var vis = this;\n  // update visibility\n  vis.visible = !vis.visible;\n  var offset = vis.visible? vis.margin.left : 3000;\n  // transition to new layout\n  vis.graph.transition().duration(1000)\n    .attr('transform', 'translate('+ offset +','+ vis.margin.top +')');\n    \n  return vis;\n}\n\n\n/*--------------------*\n *** INITIALIZATION ***\n *--------------------*/\n \n/**\n * Creates a new treemap\n *\n * @param parentElem  The ID of the DOM element within which the visualization\n *                    should be drawn.\n * @param chartElem   The ID of the DOM SVG element within which the \n *                    visualization should be drawn. \n * @param data        An array of substance abuse data organized by year\n * @return Treemap\n */\nfunction Treemap(parentElem, chartElem, data) {\n  this.parentElem = parentElem;\n  this.chartElem = chartElem;\n  this.treeData = data;\n  this.year_index = data.years[1]-data.years[0];\n  this.visible = true;\n  this.zoomed = false;\n}\n\n/**\n * If a handler is specified the Treemap updates its event handler and registers \n * listeners for the events for which it's interested. The receiving object is \n * returned.\n * If no handler is given returns the object's current handler.\n *\n * @param handler (OptionaL)  The event handler for the object\n * @return Treemap|EventHandler\n */\nTreemap.prototype.eventHandler = function(eventHandler) {\n  if (eventHandler) {\n    this._eventHandler = eventHandler;\n    this._eventHandler.on('switchView', this, this.switchView);\n    this._eventHandler.on('updateDrugs', this, this.handleUpdate);\n    \n    return this;\n  }\n  \n  return this._eventHandler;\n}\n\n\n/**\n * Initializes the visualization by appending the necessary svg groups and \n * defining scales and axes. Should only be called once on a given stacked area\n * chart.\n *\n * @return StackedAreaChart\n */\nTreemap.prototype.initVis = function() {\n  var vis = this;\n  \n  d3.select('#chart-title').text('Drug Treatment Cases By Substance Type');\n  \n  vis.svg = d3.select('#'+vis.parentElem).selectAll('svg#'+vis.chartElem);\n  if (vis.svg.empty()) {\n    vis.svg = d3.select('#'+vis.parentElem).append('svg');\n  }\n  \n  vis.graph = vis.svg.append('g')\n    .classed('chart', true)\n    .attr('opacity', 1);\n  \n  vis.x = d3.scale.linear();\n  vis.y = d3.scale.linear();\n  \n  vis.treemap = d3.layout.treemap()\n    .round(false)\n    .sticky(true);\n\n    /*** treemap TIP ***/\n  vis.tip = d3.tip()\n    .attr('class', 'd3-tip')\n    .html(function(d) {\n        return \"Substance Type: \"+ d.name + \"<br> Number of People Seeking Treatment : \" + d.size[vis.year_index];\n    });\n  vis.graph.call(vis.tip);\n\n  vis.resize();\n}\n\n\n/*------------*\n *** SIZING ***\n *------------*/\n\n/**\n * Resizes the visualization and redraws it within its parent element.\n *\n * @return Choropleth\n */\nTreemap.prototype.resize = function() {\n  var vis = this;\n    \n  vis.margin = {top: 25, right: 100, bottom: 30, left: 100};\n  vis.width = parseInt(d3.select('#'+vis.parentElem).style('width')) - vis.margin.left - vis.margin.right,\n  vis.height = vis.width * .66 - vis.margin.top - vis.margin.bottom,\n  \n  vis.svg\n    .attr('width', vis.width + vis.margin.left + vis.margin.right)\n    .attr('height', vis.height + vis.margin.top + vis.margin.bottom);\n  \n  vis.graph\n    .attr('transform', 'translate('+ vis.margin.left +','+ vis.margin.top +')');\n    \n  vis.treemap.size([vis.width, vis.height]);\n  vis.x.range([0, vis.width]);\n  vis.y.range([0, vis.height]);\n\n  vis.update();\n}\n\n\n/*---------------------------*\n *** DRAWING VISUALIZATION ***\n *---------------------------*/\n\n/**\n * Coerces data into an array the state's ID and death rate.\n * Accepted Options: (currently none)\n *\n * @param options The options for wrangling data\n */\nTreemap.prototype.wrangleData = function(options) {\n  // data needs no wrangling, this function placed here for consistency\n}\n\n/**\n * Updates the visualization according to the new data year\n * Accepted Options: (currently none)\n *\n * @param options Options for redrawing the visualization \n * @return Treemap\n */\nTreemap.prototype.update = function(options) {\n  var vis = this;\n  \n  vis.wrangleData(options);\n  \n  vis.displayData = JSON.parse(JSON.stringify(this.treeData));\n  \n  vis.treemap.value(function(d) { return d.size[vis.year_index]; });\n  var nodes = vis.treemap.nodes(vis.displayData)\n      .filter(function(d) { return !d.children; });\n  vis.node = vis.displayData;\n  var root = vis.displayData;\n      \n  var cells = vis.graph.selectAll(\".cell\").data(nodes);\n  \n  // Enter\n  var cellsEnter = cells.enter().append(\"g\").attr(\"class\", \"cell\")\n      .on(\"click\", function(d) { return vis.zoom(vis.node === d.parent ? root : d.parent); });\n  cellsEnter.append(\"rect\")\n    .style(\"fill\", function(d) { return drugColors(d.parent.name); })\n      .on('mouseover', function(d) { vis.highlightSubstance(d) })\n      .on('mouseout', function(d) { vis.unhighlightSubstance(d) });\n  cellsEnter.append(\"text\")\n    .attr(\"dy\", \".35em\")\n    .attr(\"text-anchor\", \"middle\")\n    .text(function(d) { return d.name; });\n    \n  // Update        \n  cells.transition().duration(1000)\n    .attr(\"transform\", function(d) { return \"translate(\" + (d.x) + \",\" + (d.y) + \")\"; })\n  cells.selectAll('rect').transition().duration(1000)\n    .attr(\"width\", function(d) { return d.dx - 1; })\n    .attr(\"height\", function(d) { return d.dy - 1; });\n\n  cells.selectAll('text').transition().duration(1000)\n    .attr(\"x\", function(d) { return d.dx / 2; })\n    .attr(\"y\", function(d) { return d.dy / 2; })\n    .style(\"opacity\", function(d) { d.w = this.getComputedTextLength(); return d.dx > d.w ? 1 : 0; });\n}\n\nTreemap.prototype.zoom = function(d) {\n  var vis = this;\n\n  var kx = (vis.width) / d.dx, ky = (vis.height) / d.dy;\n  vis.x.domain([d.x, d.x + d.dx]);\n  vis.y.domain([d.y, d.y + d.dy]);\n\n  var t = vis.graph.selectAll(\".cell\").transition()\n    .duration(d3.event.altKey ? 7500 : 750)\n    .attr(\"transform\", function (d) {\n        return \"translate(\" + vis.x(d.x ) + \",\" + vis.y(d.y ) + \")\";\n    });\n\n  t.select(\"rect\")\n    .attr(\"width\", function (d) { return kx * d.dx - 1; })\n    .attr(\"height\", function (d) { return ky * d.dy - 1; })\n\n  t.select(\"text\")\n    .attr(\"x\", function (d) { return kx * d.dx / 2; })\n    .attr(\"y\", function (d) { return ky * d.dy / 2; })\n    .style(\"opacity\", function (d) { return kx * d.dx > d.w ? 1 : 0; });\n\n  vis.node = d;\n  //no need to stop propogation on brush events\n  if(d3.event.type != \"brush\"){d3.event.stopPropagation();}\n  \n  vis.zoomed = !vis.zoomed;\n}\n\n/**\n * Displays a d3 tip for the given substance\n *\n * @param d The substance data element that was highlighted\n * @return StackedAreaChart\n */\nTreemap.prototype.highlightSubstance = function(d) {\n    var vis = this;\n    vis.tip.show(d);\n    return vis;\n}\n\n/**\n * Removes a d3 tip from the given substance\n *\n * @param d The substance data element that was unhighlighted\n * @return StackedAreaChart\n */\nTreemap.prototype.unhighlightSubstance = function(d) {\n    var vis = this;\n    vis.tip.hide(d);\n\n    return vis;\n}\n\n\n/*--------------------*\n *** EVENT HANDLERS ***\n *--------------------*/\n\n/**\n * Switch the opacity of the visualization\n *\n * @return Treemap\n */\nTreemap.prototype.switchView = function(event) {\n  var vis = this;\n  // update visibility\n  vis.visible = !vis.visible;\n  var offset = vis.visible? vis.margin.left : -3000;\n  // transition to new layout\n  vis.graph.transition().duration(1000)\n    .attr('transform', 'translate('+ offset +','+ vis.margin.top +')');\n    \n  return vis;\n}\n\n/**\n * Handles a resize event from the visualization's event handler.\n *\n * @return Treemap\n */\nTreemap.prototype.handleResize = function(event) {\n  this.resize();\n  return this;\n}\n\n/**\n * Handles update events by calling the visualizations update method\n *\n * @param event Event data\n * @return Treemap\n */\nTreemap.prototype.handleUpdate = function(event) {\n  var vis = this;\n  \n  var year_index = event.year - 2003;\n  if (year_index != vis.year_index) {\n    vis.year_index = year_index;\n    vis.update();\n  }\n  \n  return vis;\n}\nfunction YearSlider(parentElem, range) {\n  this.parentElem = parentElem;\n  this.range = range;\n  this.years = d3.range(range[0], range[1]+1);\n  this.topYear = range[1];\n  this.bottomYear = range[1];\n  \n  this.colors = {\n    markers: {\n      top: {\n        hover: '#756BB1',\n        normal: '#54278F'\n      },\n      bottom: {\n        hover: '#6CD16C',\n        normal: '#23A923' \n      }\n    }\n  };\n}\n\nYearSlider.prototype.question = function(text) {\n  if (text) {\n    this.descriptiveText = text;\n    return this;\n  }\n  \n  return this.descriptiveText;\n}\n\nYearSlider.prototype.eventHandler = function(handler) {\n  if (handler) {\n    this._eventHandler = handler;\n    this._eventHandler.on('resize', this, this.handleResize);\n    \n    return this;\n  }\n  \n  return this._eventHandler;\n}\n\nYearSlider.prototype.initVis = function() {\n  // grab reference to vis\n  var vis = this;\n  \n  /*** SIZES AND SVG ***/\n  vis.margin = { top: 10, right: 20, bottom: 10, left: 20};\n  vis.marker = {radius: 10};\n  vis.axis = {tick: {height: 10}};\n  \n  vis.svg = d3.select('#'+vis.parentElem).append('svg');\n  vis.slider = vis.svg.append('g');\n  \n  /*** SCALE ***/\n  vis.x = d3.scale.linear()\n    .domain(vis.range);\n  \n  /* * DRAWING GROUPS ***/\n  vis.dualSlider = vis.slider.append('g').classed('slider dual', true);\n  vis.topSlider = vis.slider.append('g').classed('slider top', true);\n  vis.bottomSlider = vis.slider.append('g').classed('slider bottom', true);\n  \n  vis.yearsText = vis.slider.append('g').classed('years', true);\n  \n  vis.topAxis = vis.topSlider.append('g').classed('axis top-axis', true);\n  vis.bottomAxis = vis.bottomSlider.append('g').classed('axis bottom', true);\n    \n  vis.topAxisLine = vis.topAxis.append('line').attr('stroke-width', 4);\n  vis.bottomAxisLine = vis.bottomAxis.append('line').attr('stroke-width', 4);\n  \n  /*** SLIDER TEXT ***/\n  vis.topText = vis.topSlider.append('text')\n    .classed('axis-label top', true)\n    .text('Death Rate')\n    .attr('text-anchor', 'middle');\n  vis.bottomText = vis.bottomSlider.append('text')\n    .classed('axis-label bottom', true)\n    .text('Factor Data')\n    .attr('text-anchor', 'middle');\n  \n  vis.questionButton = vis.slider.append('text')\n    .classed('slider question', true)\n    .html('&#xf29c')\n    .on('click', function(d) {vis.questionClicked();});\n  \n  vis.yearsText.selectAll('text')\n    .data(vis.years).enter()\n    .append('text')\n      .text(function(d) { return d; })\n      .attr('text-anchor', 'middle')\n      .attr('transform', 'rotate(90)')\n  \n  /*** DRAG BEHAVIOR ***/\n  vis.dragDualSlider = d3.behavior.drag()\n    .on('dragstart', function(d) { vis.dualSliderStartedDragging(d); })\n    .on('drag', function(d) { vis.dualSliderDragged(d); })\n    .on('dragend', function(d) { vis.dualSliderEndedDragging(d);});\n  vis.dragTopMarker = d3.behavior.drag()\n    .on('dragstart', function(d) { vis.topMarkerStartedDragging(d); })\n    .on('drag', function(d) { vis.markerDragged(d); })\n    .on('dragend', function(d) { vis.markerEndedDragging(d); });\n  vis.dragBottomMarker = d3.behavior.drag()\n    .on('dragstart', function(d) { vis.bottomMarkerStartedDragging(d); })\n    .on('drag', function(d) { vis.markerDragged(d); })\n    .on('dragend', function(d) { vis.markerEndedDragging(d); });\n  \n  // resize within bounds\n  vis.resize();\n\n  // return vis for chaining\n  return vis;\n}\n\nYearSlider.prototype.resize = function() {\n  // grab reference to vis\n  var vis = this;\n  \n  // update width with new parameters\n  vis.width = parseInt(d3.select('#'+vis.parentElem).style('width')) - vis.margin.left - vis.margin.right;\n  vis.height = (1/2) * vis.width;\n  \n  /*** RESIZE SVG AND MAIN GROUP ***/\n  vis.svg\n    .attr('width', vis.width + vis.margin.left + vis.margin.right)\n    .attr('height', vis.height + vis.margin.top + vis.margin.bottom);\n  vis.slider\n    .attr('transform', 'translate('+ vis.margin.left +','+ vis.margin.top +')');\n    \n  vis.topText.attr('x', vis.width/2)\n    .attr('y', -15);\n  vis.bottomText.attr('x', vis.width/2)\n    .attr('y', 25);\n  /*** UPDATE SCALE ***/\n  vis.x.range([0, vis.width]);\n  \n  /*** RESIZE DRAWING GROUPS ***/\n  vis.topSlider.attr('transform', 'translate(0,'+ Math.floor(vis.height / 4) +')');\n  vis.bottomSlider.attr('transform', 'translate(0,'+ vis.height / 4 * 3 +')');\n  vis.dualSlider.attr('transform', 'translate(0,'+ (vis.height / 4) +')');\n  \n  vis.topAxisLine\n    .attr('x0', 0)\n    .attr('x1', vis.width);\n  vis.bottomAxisLine\n    .attr('x0', 0)\n    .attr('x1', vis.width);\n  \n  vis.yearsText\n    .attr('transform', 'translate(0,'+ vis.height/2 +')');     \n    \n  vis.yearsText.selectAll('text')\n    .attr('y', function(d) { return -vis.x(d) + 4; });\n  \n  vis.questionButton.attr('x', vis.width)\n    .attr('y', vis.height + 5);\n  \n  // update visualization now that size is set\n  vis.update();\n  \n  // return vis for chaining\n  return vis;\n}\n\nYearSlider.prototype.update = function() {\n  var vis = this;\n  \n  vis.updateMarkers();\n  vis.updateText();\n}\n\nYearSlider.prototype.updateText = function() {\n  var vis = this;\n  \n  var maxYear = d3.max([vis.topYear, vis.bottomYear]);\n  var minYear = d3.min([vis.topYear, vis.bottomYear]);\n  \n  vis.yearsText.selectAll('text')\n    .attr('font-weight', function(d) {\n      return (d >= minYear && d <= maxYear) ? 'bold' : 'lighter';\n    })\n    .attr('fill', function(d) {\n      return (d >= minYear && d <= maxYear) ? '#fff' : '#333';\n    });\n}\n\nYearSlider.prototype.updateMarkers = function() {\n  var vis = this;\n  \n  var draggingBoxData;\n  if (vis.bottomYear < vis.topYear) {\n    draggingBoxData = [{left:vis.bottomYear, right:vis.topYear}];\n  } else {\n    draggingBoxData = [{left:vis.topYear, right:vis.bottomYear}];\n  }\n  \n  var draggingBox = vis.dualSlider.selectAll('rect').data(draggingBoxData);\n  draggingBox.enter().append('rect')\n    .classed('dragging-box', true)\n    .attr('fill', '#000')\n    .attr('opacity', 0.8)\n    .call(vis.dragDualSlider);\n  \n  draggingBox.transition().duration(250)\n    .attr('x', function(d) { return vis.x(d.left) - vis.marker.radius;})\n    .attr('width', function(d) { return vis.x(d.right) - vis.x(d.left) + 2*vis.marker.radius;})\n    .attr('height', vis.height/2);\n  \n  topMarker = vis.topSlider.selectAll('circle').data([vis.topYear]);\n  // enter\n  topMarker.enter()\n    .append('circle')\n      .attr('r', vis.marker.radius)\n      .on('mouseover', function() {vis.changeMarkerColor(topMarker, vis.colors.markers.top.hover);})\n      .on('mouseout', function() {vis.changeMarkerColor(topMarker, vis.colors.markers.top.normal);})\n      .call(vis.dragTopMarker);\n  // update  \n  topMarker.transition().duration(250)\n    .attr('cx', vis.x);\n    \n  var bottomMarker = vis.bottomSlider.selectAll('circle').data([vis.bottomYear]);\n  // enter\n  bottomMarker.enter()\n    .append('circle')\n      .attr('r', vis.marker.radius)\n      .on('mouseover', function() {vis.changeMarkerColor(bottomMarker, vis.colors.markers.bottom.hover);})\n      .on('mouseout', function() {vis.changeMarkerColor(bottomMarker, vis.colors.markers.bottom.normal);})\n      .call(vis.dragBottomMarker);\n  // update\n  bottomMarker.transition().duration(250)\n    .attr('cx', vis.x);\n}\n\nYearSlider.prototype.changeMarkerColor = function(marker, color) {\n  marker.attr('fill', color);\n}\n\nYearSlider.prototype.handleResize = function(event) {\n  this.resize();\n}\n\n/***--------------------------***\n *** MARKER DRAGGING BEHAVIOR ***\n ***--------------------------***/\n \nYearSlider.prototype.topMarkerStartedDragging = function(d) {\n  this.draggingSlider = 'topSlider';\n  this.draggingYear = 'topYear';\n  this.markerStartedDragging(d);\n}\n\nYearSlider.prototype.bottomMarkerStartedDragging = function(d) {\n  this.draggingSlider = 'bottomSlider';\n  this.draggingYear = 'bottomYear';\n  this.markerStartedDragging(d);\n}\n\nYearSlider.prototype.markerStartedDragging = function(d) {\n  // this[this.draggingSlider].selectAll('circle').classed('dragging', true);\n}\n\nYearSlider.prototype.markerDragged = function(d) {\n  var vis = this;\n  // redraw objects as drag moves\n  // dragging should not extend objects outside of the slider's svg\n  var x = d3.min([d3.max([d3.event.x, 0]), vis.width]);\n  vis[vis.draggingSlider].select('circle').attr('cx', x);\n  vis[vis.draggingYear] = Math.round(vis.x.invert(x));\n  \n  // update dual slider box\n  xs = d3.extent([\n    +vis.topSlider.select('circle').attr('cx'), \n    +vis.bottomSlider.select('circle').attr('cx')\n  ]);\n  x0 = xs[0] - vis.marker.radius;\n  width = xs[1] - xs[0] + 2*vis.marker.radius;\n  \n  vis.dualSlider.selectAll('rect')\n    .attr('x', x0)\n    .attr('width', width);\n    \n  vis.updateText();\n}\n\n\nYearSlider.prototype.markerEndedDragging = function(d) {\n  // set new year values and call update to animate transition into stopping point\n  // broadcast new year values\n  // this[this.draggingSlider].selectAll('circle').classed('dragging', false);\n  this.updateMarkers();\n  this.eventHandler().broadcast({\n    name:'update', \n    options:{\n      years: [parseYear(this.topYear.toString()), parseYear(this.bottomYear.toString())]\n    }\n  });\n}\n\nYearSlider.prototype.dualSliderStartedDragging = function(d) {\n  var vis = this;\n  vis.prevX = d3.event.sourceEvent.x;\n}\n\nYearSlider.prototype.dualSliderDragged = function(d) {\n  var vis = this;\n  var dx = d3.event.sourceEvent.x - vis.prevX;\n  vis.prevX = d3.event.sourceEvent.x;\n  \n  var topYearMarker = vis.topSlider.select('circle');\n  var bottomYearMarker = vis.bottomSlider.select('circle');\n  \n  // update x\n  var newTopYearX = vis.updateCircleX(+topYearMarker.attr('cx'), dx);\n  var newBottomYearX = vis.updateCircleX(+bottomYearMarker.attr('cx'), dx);\n  \n  topYearMarker.attr('cx', newTopYearX);\n  bottomYearMarker.attr('cx', newBottomYearX);\n  \n  // update dragging years\n  vis.topYear = Math.round(vis.x.invert(newTopYearX));\n  vis.bottomYear = Math.round(vis.x.invert(newBottomYearX));\n  vis.dualSlider.select('rect')\n    .attr('x', d3.min([newTopYearX - vis.marker.radius, newBottomYearX - vis.marker.radius]))\n    .attr('width', Math.abs(newTopYearX - newBottomYearX) + 2*vis.marker.radius);\n  \n  vis.updateText();\n}\n\nYearSlider.prototype.updateCircleX = function(cx, dx) {\n  return d3.min([d3.max([cx+dx, 0]), this.width]);\n}\n\nYearSlider.prototype.dualSliderEndedDragging = function(d) {\n  this.markerEndedDragging(d);\n}\n\nYearSlider.prototype.questionClicked = function() {\n  this.eventHandler().broadcast({\n    name:'question-clicked',\n    options: {}\n  });\n}\n\n\n\n\n\n\n\n\n\n\n\n\n"],"sourceRoot":"/source/"}